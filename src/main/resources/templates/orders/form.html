<!--<!DOCTYPE html>-->
<!--<html lang="vi"-->
<!--      xmlns:th="http://www.thymeleaf.org"-->
<!--      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"-->
<!--      layout:decorate="~{layout/main}">-->
<!--<body>-->
<!--<section layout:fragment="content">-->
<!--    <h1 th:text="${form.id != null} ? 'S·ª≠a ƒë∆°n h√†ng' : 'T·∫°o ƒë∆°n h√†ng'">T·∫°o ƒë∆°n h√†ng</h1>-->

<!--    <form th:action="${form.id != null} ? @{'/admin/sales/orders/' + ${form.id} + '/edit'} : @{/admin/sales/orders/new}"-->
<!--          method="post" class="vstack gap-3">-->

<!--        <div class="d-flex gap-3">-->
<!--            <div class="flex-1">-->
<!--                <label>Customer</label>-->
<!--                <select class="form-select" name="customerId" required>-->
<!--                    <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.fullname}"-->
<!--                            th:selected="${form.customerId != null and form.customerId == c.id}"></option>-->
<!--                </select>-->
<!--            </div>-->
<!--            <div class="flex-1">-->
<!--                <label>Code</label>-->
<!--                <input class="form-control" name="code" th:value="${form.code}" placeholder="ƒê·ªÉ tr·ªëng s·∫Ω t·ª± sinh">-->
<!--            </div>-->
<!--        </div>-->

<!--        <div class="d-flex gap-3">-->
<!--            <div class="flex-1">-->
<!--                <label>Status</label>-->
<!--                <select class="form-select" name="status">-->
<!--                    <option th:each="s: ${orderStatuses}" th:value="${s}" th:text="${s}" th:selected="${form.status == s}"></option>-->
<!--                </select>-->
<!--            </div>-->
<!--            <div class="flex-1">-->
<!--                <label>Payment</label>-->
<!--                <select class="form-select" name="paymentStatus">-->
<!--                    <option th:each="s: ${paymentStatuses}" th:value="${s}" th:text="${s}" th:selected="${form.paymentStatus == s}"></option>-->
<!--                </select>-->
<!--            </div>-->
<!--            <div class="flex-1">-->
<!--                <label>Shipping</label>-->
<!--                <select class="form-select" name="shippingStatus">-->
<!--                    <option th:each="s: ${shippingStatuses}" th:value="${s}" th:text="${s}" th:selected="${form.shippingStatus == s}"></option>-->
<!--                </select>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div>-->
<!--            <label>Shipping address</label>-->
<!--            <input class="form-control" name="shippingAddress" th:value="${form.shippingAddress}">-->
<!--        </div>-->

<!--        <div class="d-flex gap-3">-->
<!--            <div class="flex-1">-->
<!--                <label>Discount</label>-->
<!--                <input class="form-control" type="number" step="0.01" name="discountAmount" th:value="${form.discountAmount}">-->
<!--            </div>-->
<!--            <div class="flex-1">-->
<!--                <label>Shipping fee</label>-->
<!--                <input class="form-control" type="number" step="0.01" name="shippingFee" th:value="${form.shippingFee}">-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Items &ndash;&gt;-->
<!--        <div>-->
<!--            <div class="d-flex align-items-center justify-content-between">-->
<!--                <h5>Items</h5>-->
<!--                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow()">+ Th√™m d√≤ng</button>-->
<!--            </div>-->
<!--            <table class="table table-sm align-middle mt-2" id="itemsTable">-->
<!--                <thead class="table-light">-->
<!--                <tr><th>Variant ID</th><th>Price</th><th>Qty</th><th></th></tr>-->
<!--                </thead>-->
<!--                <tbody>-->
<!--                &lt;!&ndash; N·∫øu ch∆∞a c√≥ item n√†o: render 1 d√≤ng tr·ªëng &ndash;&gt;-->
<!--                <tr th:if="${form.variantIds == null or #lists.isEmpty(form.variantIds)}">-->
<!--                    <td><input class="form-control" name="variantIds"></td>-->
<!--                    <td><input class="form-control" type="number" step="0.01" name="prices"></td>-->
<!--                    <td><input class="form-control" type="number" name="qtys" value="1"></td>-->
<!--                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">X</button></td>-->
<!--                </tr>-->

<!--                &lt;!&ndash; N·∫øu ƒë√£ c√≥ item: l·∫∑p theo ch·ªâ s·ªë 0..n-1 b·∫±ng #numbers.sequence &ndash;&gt;-->
<!--                <tr th:if="${form.variantIds != null and !#lists.isEmpty(form.variantIds)}"-->
<!--                    th:each="i : ${#numbers.sequence(0, form.variantIds.size() - 1)}">-->
<!--                    <td><input class="form-control" name="variantIds" th:value="${form.variantIds[i]}"></td>-->
<!--                    <td><input class="form-control" type="number" step="0.01" name="prices" th:value="${form.prices[i]}"></td>-->
<!--                    <td><input class="form-control" type="number" name="qtys" th:value="${form.qtys[i]}"></td>-->
<!--                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">X</button></td>-->
<!--                </tr>-->
<!--                </tbody>-->

<!--            </table>-->
<!--        </div>-->

<!--        <div class="d-flex gap-2">-->
<!--            <button class="btn btn-primary" type="submit" th:text="${form.id != null} ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi'">T·∫°o m·ªõi</button>-->
<!--            <a th:href="@{/admin/sales/orders}" class="btn btn-outline-secondary">Quay l·∫°i</a>-->
<!--        </div>-->
<!--    </form>-->

<!--    <script>-->
<!--        function addRow() {-->
<!--            const tbody = document.querySelector('#itemsTable tbody');-->
<!--            const tr = document.createElement('tr');-->
<!--            tr.innerHTML = `-->
<!--        <td><input class="form-control" name="variantIds"></td>-->
<!--        <td><input class="form-control" type="number" step="0.01" name="prices"></td>-->
<!--        <td><input class="form-control" type="number" name="qtys" value="1"></td>-->
<!--        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">X</button></td>`;-->
<!--            tbody.appendChild(tr);-->
<!--        }-->
<!--        function removeRow(btn) {-->
<!--            btn.closest('tr').remove();-->
<!--        }-->
<!--    </script>-->
<!--</section>-->
<!--</body>-->
<!--</html>-->
<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        /*
        ====================================================
        1. BI·∫æN CSS V√Ä M√ÄU S·∫ÆC SEMANTIC (Gi·ªØ nguy√™n)
        ====================================================
        */
        :root {
            /* M√†u n·ªÅn v√† ch·ªØ c∆° b·∫£n */
            --bg:#F8F9FA;      /* N·ªÅn Dashboard */
            --surface:#FFFFFF; /* N·ªÅn Cards/Widgets (N·ªÅn form) */
            --text:#212529;    /* VƒÉn b·∫£n Ch√≠nh (High Contrast) */
            --muted:#6C757D;   /* VƒÉn b·∫£n Ph·ª•, ƒë∆∞·ªùng l∆∞·ªõi */
            --bd: #ffffff;      /* Vi·ªÅn/ƒê∆∞·ªùng chia */
            --ring:#ADB5BD;    /* V√≤ng focus/shadow */

            /* M√†u Primary */
            --primary:#007BFF;   /* Xanh D∆∞∆°ng ƒê·∫≠m (Primary) */
            --primary-hover:#0056B3; /* Hover t·ªëi h∆°n */
            --primary-ring:rgba(0, 123, 255, 0.4); /* V√≤ng focus */

            /* M√†u Semantic */
            --danger:#DC3545;    /* ƒê·ªè R·ª±c (CANCELLED, FAILED) */
            --success:#28A745;   /* Xanh L√° (PAID, DELIVERED) */
            --warning:#FFC107;   /* V√†ng Cam (PENDING, UNPAID) */
            --info:#17A2B8;      /* Xanh Lam (CONFIRMED, SHIPPED) */
            --vip:#6F42C1;       /* T√≠m (REFUNDED, RETURNED) */

            --danger-bg:rgba(220,53,69,.15);
        }

        /* ƒê·ªìng b·ªô Font v√† M√†u n·ªÅn */
        body { font-family: "Inter", system-ui, sans-serif; font-weight: 400; color: var(--text); background: var(--bg); }

        .wrap { max-width:1200px; margin:0 auto; }
        .card { background:var(--surface); border:1px solid var(--bd); border-radius:1rem;
            box-shadow:0 1px 3px rgba(33,37,41,.1); }

        .section-title { display:flex; align-items:center; justify-content:center; margin:24px 16px 16px; }
        .section-title h1 { font-size:28px; font-weight:800; margin:0; color:var(--text); }

        /* Inputs */
        .field {
            width:100%; padding:.75rem .9rem;
            border:1px solid var(--bd); border-radius:.75rem;
            background:var(--surface); font-size:.95rem; color:var(--text); transition:.18s ease;
        }
        .field:focus { outline:none; box-shadow:0 0 0 3px var(--primary-ring); border-color:var(--primary); }

        .label { display:block; font-size:.875rem; color:var(--muted); margin-bottom:.35rem; font-weight:500; }

        /* Buttons (Gi·ªØ nguy√™n) */
        .btn { font-weight:600; line-height:1.1; border:1px solid transparent; white-space:nowrap; cursor:pointer; transition:.18s ease; }
        .btn-lg { font-size:1rem; padding:.75rem 1.2rem; border-radius:.75rem; min-width:140px; box-shadow:0 1px 2px rgba(33,37,41,.05); }
        .btn-primary { background:var(--primary); border-color:var(--primary); color:#fff !important; font-weight:700; }
        .btn-primary:hover { background:var(--primary-hover); border-color:var(--primary-hover); }
        .btn-outline { background:var(--surface); color:var(--text); border:1px solid var(--bd); font-weight:600; }
        .btn-outline:hover { background:var(--bg); }
        .btn-danger { background:var(--danger); color:#fff; border:1px solid var(--danger); font-size:.75rem; padding:.3rem .5rem; border-radius:.4rem; font-weight:700;}
        .btn-outline-primary { border:1px solid var(--primary); color:var(--primary); background:var(--surface); font-weight:600; padding:.6rem .9rem; border-radius:.75rem; }
        .btn-outline-primary:hover { background:#EFF6FF; }

        /* Layout helpers */
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
        .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
        .stack { display:grid; gap:16px; }
        @media (max-width:992px){ .grid-2,.grid-3{grid-template-columns:1fr;} }

        /* Table (Item list - Gi·ªØ nguy√™n) */
        .table { width:100%; border-collapse:separate; border-spacing:0; }
        .table thead th { font-size:.8rem; text-transform:uppercase; letter-spacing:.02em; color:var(--muted); padding:.7rem .85rem; border-bottom:1px solid var(--bd); background:var(--bg); font-weight:600; }
        .table tbody td { padding:.7rem .85rem; border-bottom:1px solid var(--bd); vertical-align:middle; font-weight:400; }
        .table tbody tr:hover { background:var(--bg); }
        .cell-actions { display:flex; gap:6px; justify-content:center; }
        .form-actions { display:flex; justify-content:flex-end; gap:12px; flex-wrap:wrap; margin-top:20px; }


        /*
        ====================================================
        2. T√ôY CH·ªàNH SELECT2 (Fix: N·ªÅn Select Box Tr·∫Øng)
        ====================================================
        */
        .select2-container .select2-selection--single {
            height: auto;
            padding: .75rem 1rem .75rem 1rem;
            border: 1px solid var(--bd);
            border-radius: .75rem !important;
            background-color: var(--surface) !important; /* ƒê·∫£m b·∫£o n·ªÅn tr·∫Øng cho box select */
            box-shadow: none !important;
            font-size: .95rem;
            color: var(--text);
            transition: .18s ease;
        }

        /* FIX QUAN TR·ªåNG: ƒê·∫£m b·∫£o text/content kh√¥ng c√≥ padding th·ª´a */
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding: 0 !important;
            line-height: 1.1;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100%;
            top: 0;
            right: 0.5rem;
            width: 25px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: var(--muted) transparent transparent transparent !important;
            border-width: 6px 4px 0 4px !important;
            margin-left: -4px;
        }

        .select2-container--default.select2-container--focus .select2-selection--single {
            box-shadow: 0 0 0 3px var(--primary-ring) !important;
            border-color: var(--primary) !important;
        }
        /* (C√°c style Select2 kh√°c gi·ªØ nguy√™n) */
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="wrap">
        <div class="section-title">
            <h1 th:text="${form.id != null} ? 'üìù S·ª≠a ƒë∆°n h√†ng #' + ${form.code} : '‚ú® T·∫°o ƒë∆°n h√†ng m·ªõi'">T·∫°o ƒë∆°n h√†ng</h1>
        </div>

        <div class="card" style="margin:16px;padding:20px"> <form th:action="${form.id != null} ? @{'/admin/sales/orders/' + ${form.id} + '/edit'} : @{/admin/sales/orders/new}"
                                                                  method="post" class="stack">

            <div class="grid-2">
                <div>
                    <label class="label">Kh√°ch h√†ng <span style="color:var(--danger)">*</span></label>
                    <select id="customer-select" class="field" name="customerId" required>
                        <option value="" disabled th:selected="${form.customerId == null}">Ch·ªçn kh√°ch h√†ng</option>
                        <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.fullname}" th:selected="${form.customerId != null and form.customerId == c.id}"></option>
                    </select>
                </div>
                <div>
                    <label class="label">M√£ ƒë∆°n h√†ng</label>
                    <input class="field" name="code" th:value="${form.code}" placeholder="ƒê·ªÉ tr·ªëng s·∫Ω t·ª± sinh" th:readonly="${form.id != null}">
                </div>
            </div>

            <div class="grid-3">
                <div>
                    <label class="label">Tr·∫°ng th√°i ƒë∆°n</label>
                    <select id="status-select" class="field" name="status">
                        <option value="" disabled th:selected="${form.status == null}">Ch·ªçn tr·∫°ng th√°i</option>
                        <option th:each="s: ${orderStatuses}" th:value="${s}" th:text="${#strings.capitalizeWords(#strings.replace(s.name(),'_',' '))}" th:selected="${form.status == s}"></option>
                    </select>
                </div>
                <div>
                    <label class="label">Tr·∫°ng th√°i thanh to√°n</label>
                    <select id="payment-select" class="field" name="paymentStatus">
                        <option value="" disabled th:selected="${form.paymentStatus == null}">Ch·ªçn thanh to√°n</option>
                        <option th:each="s: ${paymentStatuses}" th:value="${s}" th:text="${#strings.capitalizeWords(#strings.replace(s.name(),'_',' '))}" th:selected="${form.paymentStatus == s}"></option>
                    </select>
                </div>
                <div>
                    <label class="label">Tr·∫°ng th√°i v·∫≠n chuy·ªÉn</label>
                    <select id="shipping-select" class="field" name="shippingStatus">
                        <option value="" disabled th:selected="${form.shippingStatus == null}">Ch·ªçn v·∫≠n chuy·ªÉn</option>
                        <option th:each="s: ${shippingStatuses}" th:value="${s}" th:text="${#strings.capitalizeWords(#strings.replace(s.name(),'_',' '))}" th:selected="${form.shippingStatus == s}"></option>
                    </select>
                </div>
            </div>

            <div>
                <label class="label">ƒê·ªãa ch·ªâ giao h√†ng</label>
                <input class="field" name="shippingAddress" th:value="${form.shippingAddress}" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng">
            </div>

            <div class="grid-2">
                <div>
                    <label class="label">Gi·∫£m gi√° (VND)</label>
                    <input class="field" type="number" step="1" name="discountAmount" th:value="${form.discountAmount}" placeholder="0">
                </div>
                <div>
                    <label class="label">Ph√≠ giao h√†ng (VND)</label>
                    <input class="field" type="number" step="1" name="shippingFee" th:value="${form.shippingFee}" placeholder="0">
                </div>
            </div>

            <div class="card" style="padding:16px; margin-top:8px"> <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0">
                <h3 style="margin:0;font-size:18px;font-weight:700;color:var(--text)">üõí Chi ti·∫øt s·∫£n ph·∫©m</h3>
                <button type="button" class="btn btn-outline-primary btn-lg" onclick="addRow()">‚ûï Th√™m s·∫£n ph·∫©m</button>
            </div>
                <div style="margin-top:12px;overflow:auto">
                    <table class="table align-middle" id="itemsTable">
                        <thead>
                        <tr><th>M√£ SKU / ID Variant</th><th>Gi√° b√°n l·∫ª</th><th>S·ªë l∆∞·ª£ng</th><th style="width:70px;text-align:center"></th></tr>
                        </thead>
                        <tbody>
                        <tr th:if="${form.variantIds == null or #lists.isEmpty(form.variantIds)}">
                            <td><input class="field" name="variantIds" placeholder="M√£ SKU (VD: XM-AT-001)"></td>
                            <td><input class="field" type="number" step="1" name="prices" placeholder="0"></td>
                            <td><input class="field" type="number" name="qtys" value="1" min="1"></td>
                            <td class="cell-actions">
                                <button type="button" class="btn btn-danger" onclick="removeRow(this)">X</button>
                            </td>
                        </tr>
                        <tr th:if="${form.variantIds != null and !#lists.isEmpty(form.variantIds)}"
                            th:each="i : ${#numbers.sequence(0, form.variantIds.size() - 1)}">
                            <td><input class="field" name="variantIds" th:value="${form.variantIds[i]}" placeholder="M√£ SKU (VD: XM-AT-001)"></td>
                            <td><input class="field" type="number" step="1" name="prices" th:value="${form.prices[i]}" placeholder="0"></td>
                            <td><input class="field" type="number" name="qtys" th:value="${form.qtys[i]}" min="1"></td>
                            <td class="cell-actions">
                                <button type="button" class="btn btn-danger" onclick="removeRow(this)">X</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-actions">
                <a th:href="@{/admin/sales/orders}" class="btn btn-outline btn-lg">‚Üê Quay l·∫°i</a>
                <button class="btn btn-primary btn-lg" type="submit" th:text="${form.id != null} ? 'üíæ C·∫≠p nh·∫≠t ƒë∆°n' : '‚úÖ T·∫°o ƒë∆°n h√†ng'">T·∫°o m·ªõi</button>
            </div>
        </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // H√†m l·∫•y m√†u Semantic Color
        const getColor = (status) => {
            const map = {
                // Order Status
                'PLACED': { color: 'var(--primary)', icon: 'üì¶' },
                'CONFIRMED': { color: 'var(--info)', icon: 'üìù' },
                'PACKED': { color: 'var(--info)', icon: 'üöö' },
                'SHIPPING': { color: 'var(--info)', icon: 'üöÄ' },
                'DELIVERED': { color: 'var(--success)', icon: '‚úÖ' },
                'CANCELLED': { color: 'var(--danger)', icon: '‚ùå' },
                'FAILED': { color: 'var(--danger)', icon: 'üî•' },
                'PENDING': { color: 'var(--warning)', icon: '‚è≥' },
                'PENDING_PAYMENT': { color: 'var(--warning)', icon: '‚ö†Ô∏è' },

                // Payment Status
                'PAID': { color: 'var(--success)', icon: 'üí∞' },
                'UNPAID': { color: 'var(--danger)', icon: '‚ö†Ô∏è' },
                'FAILED': { color: 'var(--danger)', icon: '‚ùå' },
                // 'REFUNDED': { color: 'var(--vip)', icon: '‚Ü©Ô∏è' },

                // Shipping Status
                'SHIPPED': { color: 'var(--info)', icon: 'üöÄ' },
                'NOT_SHIPPED': { color: 'var(--warning)', icon: 'üì¶' },
                'DELIVERED': { color: 'var(--success)', icon: '‚úÖ' },
                'RETURNED': { color: 'var(--vip)', icon: '‚Ü©Ô∏è' },
            };
            return map[status] || { color: 'var(--muted)', icon: '‚ö´' };
        };

        // H√†m ƒë·ªãnh d·∫°ng Option & Selection cho Select2
        function formatState(state) {
            if (!state.id) { return state.text; }

            const status = state.id.toUpperCase().replace(/\s/g, '_');
            const data = getColor(status);
            const text = state.text;

            // ƒê√¢y l√† ph·∫ßn ƒë·ªãnh d·∫°ng cho item trong list (Option)
            if (!state.element.selected) {
                return $(`<span style="color: ${data.color}; font-weight: 600;">${data.icon} ${text.toUpperCase()}</span>`);
            }

            // FIX: Ph·∫ßn ƒë·ªãnh d·∫°ng cho gi√° tr·ªã ƒê√É CH·ªåN (Selection)
            // Kh√¥ng s·ª≠ d·ª•ng background-color ƒë·ªÉ gi·ªØ n·ªÅn tr·∫Øng c·ªßa select box
            const $state = $(
                `<span style="color: ${data.color}; font-weight: 600; padding: 0.25rem 0.5rem 0.25rem 0; border-radius: 0.4rem;">${data.icon} ${text}</span>`
            );
            return $state;
        }

        $(document).ready(function() {
            // Kh·ªüi t·∫°o Select2 cho c√°c tr∆∞·ªùng tr·∫°ng th√°i
            $('#status-select, #payment-select, #shipping-select').select2({
                minimumResultsForSearch: Infinity, // ·∫®n √¥ t√¨m ki·∫øm
                templateResult: formatState, // D√πng h√†m ƒë·ªãnh d·∫°ng cho list options
                templateSelection: formatState // D√πng h√†m ƒë·ªãnh d·∫°ng cho gi√° tr·ªã ƒë√£ ch·ªçn
            });

            // Kh·ªüi t·∫°o Select2 cho Kh√°ch h√†ng (c√≥ th·ªÉ t√¨m ki·∫øm)
            $('#customer-select').select2();
        });

        // Logic Th√™m/X√≥a Item (Gi·ªØ nguy√™n)
        function addRow() {
            const tbody = document.querySelector('#itemsTable tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input class="field" name="variantIds" placeholder="M√£ SKU (VD: XM-AT-001)"></td>
                <td><input class="field" type="number" step="1" name="prices" placeholder="0"></td>
                <td><input class="field" type="number" name="qtys" value="1" min="1"></td>
                <td class="cell-actions"><button type="button" class="btn btn-danger" onclick="removeRow(this)">X</button></td>`;
            tbody.appendChild(tr);
        }
        function removeRow(btn) { btn.closest('tr').remove(); }
    </script>
</section>
</body>
</html>