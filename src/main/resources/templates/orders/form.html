<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/orders/form.css}">
</head>
<body>
<section layout:fragment="content" class="orders-form">
    <div class="orders-form__container">
        <div class="orders-form__header">
            <h1 th:text="${form.id != null} ? 'Sua don hang #' + ${form.code} : 'Tao don hang moi'">Tao don hang</h1>
        </div>

        <form th:action="${form.id != null} ? @{'/admin/sales/orders/' + ${form.id} + '/edit'} : @{/admin/sales/orders/new}"
              method="post"
              class="orders-card orders-form__form">

            <div class="orders-grid orders-grid--two">
                <div>
                    <label>Khach hang <span class="required">*</span></label>
                    <select id="customer-select" class="field" name="customerId" required>
                        <option value="" disabled th:selected="${form.customerId == null}">Chon khach hang</option>
                        <option th:each="c : ${customers}"
                                th:value="${c.id}"
                                th:text="${c.fullname}"
                                th:selected="${form.customerId != null and form.customerId == c.id}"></option>
                    </select>
                </div>
                <div>
                    <label>Ma don hang</label>
                    <input class="field"
                           name="code"
                           th:value="${form.code}"
                           placeholder="De trong se tu sinh"
                           th:readonly="${form.id != null}">
                </div>
            </div>

            <div class="orders-grid orders-grid--three">
                <div>
                    <label>Trang thai don</label>
                    <select id="status-select" class="field" name="status">
                        <option value="" disabled th:selected="${form.status == null}">Chon trang thai</option>
                        <option th:each="s : ${orderStatuses}"
                                th:value="${s}"
                                th:text="${#strings.capitalizeWords(#strings.replace(s.name(),'_',' '))}"
                                th:selected="${form.status == s}"></option>
                    </select>
                </div>
                <div>
                    <label>Trang thai thanh toan</label>
                    <select id="payment-select" class="field" name="paymentStatus">
                        <option value="" disabled th:selected="${form.paymentStatus == null}">Chon thanh toan</option>
                        <option th:each="s : ${paymentStatuses}"
                                th:value="${s}"
                                th:text="${#strings.capitalizeWords(#strings.replace(s.name(),'_',' '))}"
                                th:selected="${form.paymentStatus == s}"></option>
                    </select>
                </div>
                <div>
                    <label>Trang thai van chuyen</label>
                    <select id="shipping-select" class="field" name="shippingStatus">
                        <option value="" disabled th:selected="${form.shippingStatus == null}">Chon van chuyen</option>
                        <option th:each="s : ${shippingStatuses}"
                                th:value="${s}"
                                th:text="${#strings.capitalizeWords(#strings.replace(s.name(),'_',' '))}"
                                th:selected="${form.shippingStatus == s}"></option>
                    </select>
                </div>
            </div>

            <div>
                <label>Dia chi giao hang</label>
                <input class="field"
                       name="shippingAddress"
                       th:value="${form.shippingAddress}"
                       placeholder="Nhap dia chi giao hang">
            </div>

            <div class="orders-grid orders-grid--two">
                <div>
                    <label>Giam gia (VND)</label>
                    <input class="field"
                           type="number"
                           step="1"
                           name="discountAmount"
                           th:value="${form.discountAmount}"
                           placeholder="0">
                </div>
                <div>
                    <label>Phi giao hang (VND)</label>
                    <input class="field"
                           type="number"
                           step="1"
                           name="shippingFee"
                           th:value="${form.shippingFee}"
                           placeholder="0">
                </div>
            </div>

            <div class="orders-items">
                <div class="orders-items__header">
                    <h3 class="orders-items__title">Chi tiet san pham</h3>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRow()">+ Them san pham</button>
                </div>
                <div class="orders-items__table">
                    <table class="orders-table" id="itemsTable">
                        <thead>
                        <tr>
                            <th>Ma SKU / ID Variant</th>
                            <th>Gia ban le</th>
                            <th>So luong</th>
                            <th class="cell-actions"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${form.variantIds == null || #lists.isEmpty(form.variantIds)}">
                            <td><input class="field" name="variantIds" placeholder="Ma SKU (VD: XM-AT-001)"></td>
                            <td><input class="field" type="number" step="1" name="prices" placeholder="0"></td>
                            <td><input class="field" type="number" name="qtys" value="1" min="1"></td>
                            <td class="cell-actions">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button>
                            </td>
                        </tr>
                        <tr th:if="${form.variantIds != null && !#lists.isEmpty(form.variantIds)}"
                            th:each="i : ${#numbers.sequence(0, form.variantIds.size() - 1)}">
                            <td><input class="field" name="variantIds" th:value="${form.variantIds[i]}" placeholder="Ma SKU (VD: XM-AT-001)"></td>
                            <td><input class="field" type="number" step="1" name="prices" th:value="${form.prices[i]}" placeholder="0"></td>
                            <td><input class="field" type="number" name="qtys" th:value="${form.qtys[i]}" min="1"></td>
                            <td class="cell-actions">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-actions">
                <a th:href="@{/admin/sales/orders}" class="btn btn-outline-secondary btn-lg">Quay lai</a>
                <button class="btn btn-primary btn-lg" type="submit"
                        th:text="${form.id != null} ? 'Cap nhat don' : 'Tao don moi'">Tao don moi</button>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        const getStatusColor = (status) => {
            const map = {
                'PLACED': 'var(--primary)',
                'CONFIRMED': 'var(--info)',
                'PACKED': 'var(--info)',
                'SHIPPING': 'var(--info)',
                'DELIVERED': 'var(--success)',
                'CANCELLED': 'var(--danger)',
                'FAILED': 'var(--danger)',
                'PENDING': 'var(--warning)',
                'PENDING_PAYMENT': 'var(--warning)',
                'PAID': 'var(--success)',
                'UNPAID': 'var(--danger)',
                'REFUNDED': 'var(--vip)',
                'SHIPPED': 'var(--info)',
                'NOT_SHIPPED': 'var(--warning)',
                'RETURNED': 'var(--vip)'
            };
            return map[status] || 'var(--muted)';
        };

        function formatState(state) {
            if (!state.id) { return state.text; }

            const statusKey = state.id.toString().toUpperCase().replace(/\s/g, '_');
            const color = getStatusColor(statusKey);
            const text = state.text;

            if (!state.element.selected) {
                return $(`<span class="orders-status-option" style="color:${color};">${text.toUpperCase()}</span>`);
            }

            return $(`<span class="orders-status-pill" style="color:${color};">${text}</span>`);
        }

        $(function() {
            $('#status-select, #payment-select, #shipping-select').select2({
                minimumResultsForSearch: Infinity,
                templateResult: formatState,
                templateSelection: formatState
            });

            $('#customer-select').select2();
        });

        function addRow() {
            const tbody = document.querySelector('#itemsTable tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input class="field" name="variantIds" placeholder="Ma SKU (VD: XM-AT-001)"></td>
                <td><input class="field" type="number" step="1" name="prices" placeholder="0"></td>
                <td><input class="field" type="number" name="qtys" value="1" min="1"></td>
                <td class="cell-actions"><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
            `;
            tbody.appendChild(tr);
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
        }
    </script>
</section>
</body>
</html>
