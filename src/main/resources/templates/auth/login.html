<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒêƒÉng nh·∫≠p</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/login.css}">
    <style>
        .error {
            color: #d00;
            text-align: center;
            margin: 8px 0
        }

        .hidden {
            display: none
        }
    </style>
</head>
<body>
<div class="backdrop">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
        <button class="close" onclick="window.location.href='/'" aria-label="ƒê√≥ng"></button>

        <div class="logo-row">
            <img class="logo" src="/images/coolclub-logo.avif" alt="COOL CLUB">
        </div>

        <h1 class="title" id="dlg-title">R·∫•t nhi·ªÅu ƒë·∫∑c quy·ªÅn v√† quy·ªÅn l·ª£i mua s·∫Øm ƒëang ch·ªù b·∫°n</h1>
        <div class="muted">Quy·ªÅn l·ª£i d√†nh ri√™ng cho b·∫°n khi tham gia Coolclub</div>

        <div class="perks">
            <div class="perk"><img src="/images/perk-voucher.avif" alt="Voucher ∆∞u ƒë√£i">
                <div><strong>Voucher ∆∞u ƒë√£i</strong></div>
            </div>
            <div class="perk"><img src="/images/perk-gift.avif" alt="Qu√† t·∫∑ng ƒë·ªôc quy·ªÅn">
                <div><strong>Qu√† t·∫∑ng ƒë·ªôc quy·ªÅn</strong></div>
            </div>
            <div class="perk"><img src="/images/perk-cash.avif" alt="Ho√†n ti·ªÅn CoolCash">
                <div><strong>Ho√†n ti·ªÅn CoolCash</strong></div>
            </div>
        </div>

        <div class="section-label">ƒêƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω (mi·ªÖn ph√≠)</div>

        <div class="socials">
            <!-- S·∫Ω render n√∫t GSI v√†o th·∫ª n√†y -->
            <a class="social-btn" href="#" id="btnGoogle" title="ƒêƒÉng nh·∫≠p Google">
                <img src="/images/ic-google.png" alt="Google">
            </a>
            <a class="social-btn" href="#" id="btnFacebook" title="ƒêƒÉng nh·∫≠p Facebook">
                <img src="/images/ic-facebook.png" alt="Facebook">
            </a>
        </div>

        <div class="or">Ho·∫∑c</div>

        <p class="error hidden" id="errLogin">Sai email ho·∫∑c m·∫≠t kh·∫©u.</p>
        <p class="error hidden" id="errGoogle">ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i.</p>
        <p class="error hidden" id="errFacebook">ƒêƒÉng nh·∫≠p Facebook th·∫•t b·∫°i.</p>
        <p th:if="${param.reset}" style="color:#0a7a2a;text-align:center">ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng, vui l√≤ng ƒëƒÉng nh·∫≠p
            l·∫°i.</p>

        <form th:action="@{/auth/login}" method="post" id="loginForm" novalidate>
            <div class="float-field">
                <input class="float-input" type="text" name="email" id="email" placeholder=" " required>
                <label class="float-label" for="email">Email/SDT c·ªßa b·∫°n</label>
            </div>

            <div class="float-field" style="position:relative">
                <input class="float-input" type="password" name="password" id="pwd" placeholder=" " required>
                <label class="float-label" for="pwd">M·∫≠t kh·∫©u</label>
                <button type="button" id="toggleEye"
                        style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer">
                    üëÅ
                </button>
            </div>

            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-primary" type="submit">ƒêƒÇNG NH·∫¨P</button>
        </form>

        <div class="links">
            <a th:href="@{/auth/register}">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</a>
            <a th:href="@{/auth/forgot}">Qu√™n m·∫≠t kh·∫©u</a>
        </div>
    </div>
</div>

<!-- Facebook SDK -->
<div id="fb-root"></div>
<script>
    // Promise resolve khi FB.init g·ªçi xong
    const fbReady = new Promise((resolve) => {
        window.fbAsyncInit = function () {
            FB.init({
                appId: '1495990908193900',
                cookie: true,        // n√™n b·∫≠t n·∫øu server d√πng session
                xfbml: false,
                version: 'v19.0'
            });
            console.log('[FB] SDK ready');
            resolve(true);
        };
    });

    // N·∫°p SDK ƒë√∫ng 1 l·∫ßn
    (function (d, s, id) {
        if (d.getElementById(id)) return;
        const js = d.createElement(s);
        js.id = id; js.async = true; js.defer = true; js.crossOrigin = 'anonymous';
        js.src = 'https://connect.facebook.net/vi_VN/sdk.js';
        d.getElementsByTagName('head')[0].appendChild(js);
    })(document, 'script', 'facebook-jssdk');
</script>

<script>
    const $ = (s) => document.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    window.handleAuthResult = async function handleAuthResult(resp, errEl){
        let text = '';
        try { text = await resp.text(); } catch {}
        if (!resp.ok) {
            console.error('Auth error:', resp.status, text);
            if (errEl) { show(errEl); errEl.textContent = (text && text.length < 200) ? text : 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.'; }
            return;
        }
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch {}
        if (data.accessToken)  localStorage.setItem('accessToken',  data.accessToken);
        if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);
        location.href = '/auth/complete';
    };
    const errFacebook = document.getElementById('errFacebook');

    $('#btnFacebook')?.addEventListener('click', async (e) => {
        e.preventDefault(); hide(errFacebook);
        try {
            // CH·ªú CH·∫ÆC FB.init xong (kh√¥ng t·ª± poll n·ªØa)
            await fbReady;

            // G·ªçi login (c√≥ th·ªÉ th√™m scope: 'email' n·∫øu app ƒë√£ ƒë∆∞·ª£c duy·ªát)
            FB.login((response) => {
                (async () => {
                    console.log('FB.login response =', response);
                    const t = response?.authResponse?.accessToken;
                    if (response.status === 'connected' && t) {
                        const resp = await fetch('/api/auth/facebook', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accessToken: t }),
                            credentials: 'include'
                        });
                        await handleAuthResult(resp, errFacebook);
                    } else {
                        show(errFacebook);
                        errFacebook.textContent = 'ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.';
                    }
                })().catch(ex => {
                    show(errFacebook);
                    errFacebook.textContent = 'L·ªói x·ª≠ l√Ω callback Facebook.';
                    console.error(ex);
                });
            }/*, { scope: 'email', return_scopes: true }*/);
        } catch (ex) {
            show(errFacebook);
            errFacebook.textContent = 'FB SDK ch∆∞a s·∫µn s√†ng ho·∫∑c b·ªã ch·∫∑n.';
            console.error(ex);
        }
    });
</script>


<!-- GSI: CH·ªà 1 SCRIPT & 1 INIT -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
    const GSI_CLIENT_ID = '96998956369-8pvvqgj35agmp1jlon8iectgsdkhdptn.apps.googleusercontent.com';

    function waitGSI() {
        return new Promise((res, rej) => {
            let n = 0, t = setInterval(() => {
                n++;
                if (window.google?.accounts?.id) {
                    clearInterval(t);
                    res();
                }
                if (n > 50) {
                    clearInterval(t);
                    rej(new Error('GSI not loaded'));
                }
            }, 100);
        });
    }

    async function initGoogle() {
        try {
            await waitGSI();

            // init GSI
            google.accounts.id.initialize({
                client_id: GSI_CLIENT_ID,
                callback: async ({credential}) => {
                    console.log('GSI credential received');
                    const resp = await fetch('/api/auth/google', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({idToken: credential})
                    });
                    await handleAuthResult(resp, document.getElementById('errGoogle'));
                }
            });

            // render n√∫t icon v√†o ch√≠nh #btnGoogle
            const btn = document.getElementById('btnGoogle');
            btn.innerHTML = ''; // xo√° <img> t·ª± v·∫Ω
            btn.style.padding = '0';
            btn.style.border = 'none';
            btn.style.background = 'transparent';
            btn.style.display = 'inline-flex';
            btn.style.alignItems = 'center';
            btn.style.justifyContent = 'center';

            google.accounts.id.renderButton(btn, {
                type: 'icon', theme: 'outline', size: 'large', shape: 'circle'
            });

            // KH√îNG g·ªçi prompt() ƒë·ªÉ tr√°nh im l·∫∑ng kh√¥ng hi·ªán
        } catch (e) {
            console.error(e);
            const el = document.getElementById('errGoogle');
            show(el);
            el.textContent = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c Google Identity.';
        }
    }

    window.addEventListener('load', initGoogle);
</script>
</body>
</html>
