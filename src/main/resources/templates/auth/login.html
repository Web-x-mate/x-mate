<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒêƒÉng nh·∫≠p</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/login.css}">
    <style>
        .error {
            color: #d00;
            text-align: center;
            margin: 8px 0
        }

        .hidden {
            display: none
        }
    </style>
</head>
<body>
<div class="backdrop">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
        <button class="close" onclick="window.location.href='/'" aria-label="ƒê√≥ng"></button>

        <div class="logo-row">
            <img class="logo" src="/images/coolclub-logo.avif" alt="COOL CLUB">
        </div>

        <h1 class="title" id="dlg-title">R·∫•t nhi·ªÅu ƒë·∫∑c quy·ªÅn v√† quy·ªÅn l·ª£i mua s·∫Øm ƒëang ch·ªù b·∫°n</h1>
        <div class="muted">Quy·ªÅn l·ª£i d√†nh ri√™ng cho b·∫°n khi tham gia Coolclub</div>

        <div class="perks">
            <div class="perk"><img src="/images/perk-voucher.avif" alt="Voucher ∆∞u ƒë√£i">
                <div><strong>Voucher ∆∞u ƒë√£i</strong></div>
            </div>
            <div class="perk"><img src="/images/perk-gift.avif" alt="Qu√† t·∫∑ng ƒë·ªôc quy·ªÅn">
                <div><strong>Qu√† t·∫∑ng ƒë·ªôc quy·ªÅn</strong></div>
            </div>
            <div class="perk"><img src="/images/perk-cash.avif" alt="Ho√†n ti·ªÅn CoolCash">
                <div><strong>Ho√†n ti·ªÅn CoolCash</strong></div>
            </div>
        </div>

        <div class="section-label">ƒêƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω (mi·ªÖn ph√≠)</div>

        <div class="socials">
            <!-- S·∫Ω render n√∫t GSI v√†o th·∫ª n√†y -->
            <a class="social-btn" href="#" id="btnGoogle" title="ƒêƒÉng nh·∫≠p Google">
                <img src="/images/ic-google.png" alt="Google">
            </a>
            <a class="social-btn" href="#" id="btnFacebook" title="ƒêƒÉng nh·∫≠p Facebook">
                <img src="/images/ic-facebook.png" alt="Facebook">
            </a>
        </div>

        <div class="or">Ho·∫∑c</div>
        <p class="error hidden" id="errLogin"></p>
        <p class="error hidden" id="errGoogle"></p>
        <p class="error hidden" id="errFacebook"></p>

        <form method="post" id="loginForm" novalidate>
            <div class="float-field">
                <input class="float-input" type="text" name="email" id="email" placeholder=" " required>
                <label class="float-label" for="email">Email/SDT c·ªßa b·∫°n</label>
            </div>

            <div class="float-field" style="position:relative">
                <input class="float-input" type="password" name="password" id="pwd" placeholder=" " required>
                <label class="float-label" for="pwd">M·∫≠t kh·∫©u</label>
                <button type="button" id="toggleEye"
                        style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer">
                    üëÅ
                </button>
            </div>

            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-primary" type="submit">ƒêƒÇNG NH·∫¨P</button>
        </form>

        <div class="links">
            <a th:href="@{/auth/register}">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</a>
            <a th:href="@{/auth/forgot}">Qu√™n m·∫≠t kh·∫©u</a>
        </div>
    </div>
</div>
<!-- ===== Modal (popup) ===== -->
<div id="appModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
            <span class="modal-icon" id="modalIcon">‚ÑπÔ∏è</span>
            <h3 class="modal-title" id="modalTitle">Th√¥ng b√°o</h3>
        </div>
        <div class="modal-body" id="modalBody">N·ªôi dung th√¥ng b√°o‚Ä¶</div>
        <div class="modal-actions">
            <button type="button" class="btn-ghost" id="modalCancel" style="display:none">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="modalOk">OK</button>
        </div>
    </div>
</div>
<script>
    // Modal helpers
    const modalEl   = document.getElementById('appModal');
    const modalTitle= document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalIcon = document.getElementById('modalIcon');
    const btnOk     = document.getElementById('modalOk');
    const btnCancel = document.getElementById('modalCancel');
    let lastFocus = null;

    function openModal(
        message,
        options = {}
    ) {
        const {
            title = 'Th√¥ng b√°o',
            type = 'info',
            okText = 'OK',
            cancelText = null,
            onOk = null,
            onCancel = null,
            useIcon = false   // <-- m·∫∑c ƒë·ªãnh KH√îNG d√πng icon
        } = options;
        lastFocus = document.activeElement;
        modalTitle.textContent = title;
        modalBody.textContent  = message;

        const box = modalEl.firstElementChild; // .modal
        box.classList.remove('modal--error','modal--success','modal--info','modal--noicon');
        box.classList.add(`modal--${type}`);
        if (!useIcon) box.classList.add('modal--noicon'); // <-- ·∫©n icon n·∫øu kh√¥ng d√πng

        modalIcon.textContent = (type==='error' ? '‚õî' : type==='success' ? '‚úÖ' : '‚ÑπÔ∏è');

        btnOk.textContent = okText || 'OK';
        btnOk.onclick = () => { closeModal(); if (typeof onOk === 'function') onOk(); };

        if (cancelText) {
            btnCancel.style.display = '';
            btnCancel.textContent = cancelText;
            btnCancel.onclick = () => { closeModal(); if (typeof onCancel === 'function') onCancel(); };
        } else {
            btnCancel.style.display = 'none';
            btnCancel.onclick = null;
        }

        modalEl.classList.add('show');
        modalEl.setAttribute('aria-hidden', 'false');
        btnOk.focus();
    }
    function closeModal() {
        modalEl.classList.remove('show');
        modalEl.setAttribute('aria-hidden', 'true');
        if (lastFocus && lastFocus.focus) lastFocus.focus();
    }
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalEl.classList.contains('show')) closeModal(); });
    modalEl.addEventListener('click', (e) => { if (e.target === modalEl) closeModal(); });

    // shortcuts
    const alertInfo    = (msg, opts={}) => openModal(msg, {type:'info',    title: opts.title || 'Th√¥ng b√°o', ...opts});
    const alertError   = (msg, opts={}) => openModal(msg, {type:'error',   title: opts.title || 'L·ªói', ...opts});
    const alertSuccess = (msg, opts={}) => openModal(msg, {type:'success', title: opts.title || 'Th√†nh c√¥ng', ...opts});
</script>


<!-- Facebook SDK -->
<div id="fb-root"></div>
<script>
    // Promise resolve khi FB.init g·ªçi xong
    const fbReady = new Promise((resolve) => {
        window.fbAsyncInit = function () {
            FB.init({
                appId: '1495990908193900',
                cookie: true,        // n√™n b·∫≠t n·∫øu server d√πng session
                xfbml: false,
                version: 'v19.0'
            });
            console.log('[FB] SDK ready');
            resolve(true);
        };
    });

    // N·∫°p SDK ƒë√∫ng 1 l·∫ßn
    (function (d, s, id) {
        if (d.getElementById(id)) return;
        const js = d.createElement(s);
        js.id = id; js.async = true; js.defer = true; js.crossOrigin = 'anonymous';
        js.src = 'https://connect.facebook.net/vi_VN/sdk.js';
        d.getElementsByTagName('head')[0].appendChild(js);
    })(document, 'script', 'facebook-jssdk');
</script>

<script>
    const $ = (s) => document.querySelector(s);
    window.show = (el) => {
        if (!el) return;
        el.classList.remove('hidden');
        // N·∫øu l√† 3 th·∫ª l·ªói c≈© -> b·∫≠t modal thay v√¨ hi·ªán text
        const id = el.id || '';
        if (id === 'errLogin' || id === 'errGoogle' || id === 'errFacebook') {
            // ƒë·ª£i 1 nh·ªãp ƒë·ªÉ ƒëo·∫°n errEl.textContent = ... ch·∫°y xong
            setTimeout(() => {
                const msg = (el.textContent || '').trim() || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.';
                alertError(msg);
                el.classList.add('hidden');    // ·∫©n l·∫°i ƒë·ªÉ kh√¥ng nh√°y UI
                el.style.display = 'none';
            }, 0);
        }
    };
    window.hide = (el) => { if (el) el.classList.add('hidden'); };


    const errFacebook = document.getElementById('errFacebook');

    $('#btnFacebook')?.addEventListener('click', async (e) => {
        e.preventDefault(); hide(errFacebook);
        try {
            // CH·ªú CH·∫ÆC FB.init xong (kh√¥ng t·ª± poll n·ªØa)
            await fbReady;

            // G·ªçi login (c√≥ th·ªÉ th√™m scope: 'email' n·∫øu app ƒë√£ ƒë∆∞·ª£c duy·ªát)
            FB.login((response) => {
                (async () => {
                    console.log('FB.login response =', response);
                    const t = response?.authResponse?.accessToken;
                    if (response.status === 'connected' && t) {
                        const resp = await fetch('/api/auth/facebook', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accessToken: t }),
                            credentials: 'include'
                        });
                        await handleAuthResult(resp, errFacebook);
                    } else {
                        alertError('ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.');

                    }
                })().catch(ex => {
                    alertError('ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.');

                    console.error(ex);
                });
            }/*, { scope: 'email', return_scopes: true }*/);
        } catch (ex) {
            alertError('ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.');

            console.error(ex);
        }
    });
</script>


<!-- GSI: CH·ªà 1 SCRIPT & 1 INIT -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
    const GSI_CLIENT_ID = '96998956369-8pvvqgj35agmp1jlon8iectgsdkhdptn.apps.googleusercontent.com';

    function waitGSI() {
        return new Promise((res, rej) => {
            let n = 0, t = setInterval(() => {
                n++;
                if (window.google?.accounts?.id) {
                    clearInterval(t);
                    res();
                }
                if (n > 50) {
                    clearInterval(t);
                    rej(new Error('GSI not loaded'));
                }
            }, 100);
        });
    }

    async function initGoogle() {
        try {
            await waitGSI();

            // init GSI
            google.accounts.id.initialize({
                client_id: GSI_CLIENT_ID,
                callback: async ({credential}) => {
                    console.log('GSI credential received');
                    const resp = await fetch('/api/auth/google', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({idToken: credential}),
                        credentials: 'include'
                    });
                    await handleAuthResult(resp, document.getElementById('errGoogle'));
                }
            });

            // render n√∫t icon v√†o ch√≠nh #btnGoogle
            const btn = document.getElementById('btnGoogle');
            btn.innerHTML = ''; // xo√° <img> t·ª± v·∫Ω
            btn.style.padding = '0';
            btn.style.border = 'none';
            btn.style.background = 'transparent';
            btn.style.display = 'inline-flex';
            btn.style.alignItems = 'center';
            btn.style.justifyContent = 'center';

            google.accounts.id.renderButton(btn, {
                type: 'icon', theme: 'outline', size: 'large', shape: 'circle'
            });

            // KH√îNG g·ªçi prompt() ƒë·ªÉ tr√°nh im l·∫∑ng kh√¥ng hi·ªán
        } catch (e) {
            alertError('Kh√¥ng t·∫£i ƒë∆∞·ª£c Google Identity.');


        }
    }

    window.addEventListener('load', initGoogle);
</script>
<script>
    const errLogin = document.getElementById('errLogin');


    async function callJson(url, body){
        return fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body),
            credentials: 'include'
        });
    }

    function decodeJwtPayload(jwt){
        try{
            const b = (jwt||'').split('.')[1] || '';
            const s = atob(b.replace(/-/g,'+').replace(/_/g,'/'));
            return JSON.parse(decodeURIComponent(escape(s)));
        }catch{ return {}; }
    }

    async function handleAuthResult(resp, errEl){
        let text = ''; try { text = await resp.text(); } catch {}
        if (!resp.ok) {
            if (errEl) { show(errEl); errEl.textContent = (text && text.length < 200) ? text : 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.'; }
            console.error('Auth error:', resp.status, text);
            return false;
        }
        let data = {}; try { data = text ? JSON.parse(text) : {}; } catch {}
        if (data.accessToken)  localStorage.setItem('accessToken',  data.accessToken);
        if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);

        // TokenRes ch·ªâ c√≥ 2 field ‚Üí ƒë·ªçc claim ƒë·ªÉ bi·∫øt c√≥ role kh√¥ng
        const p = decodeJwtPayload(data.accessToken || '');
        const isStaff = p?.actor === 'staff' && Array.isArray(p?.roles) && p.roles.length > 0;

        location.href = isStaff ? '/admin' : '/auth/complete';
        return true;
    }

    document.getElementById('loginForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        hide(errLogin);
        const email = e.target.email.value.trim();
        const password = e.target.password.value;

        // 1) th·ª≠ ƒëƒÉng nh·∫≠p admin
        let resp = await callJson('/api/admin/auth/login', { email, password });

        // 2) n·∫øu kh√¥ng ph·∫£i admin ‚Üí th·ª≠ customer
        if (!resp.ok) resp = await callJson('/api/auth/login', { email, password });

        await handleAuthResult(resp, errLogin);
    });
</script>

</body>
</html>
