<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Cập nhật tài khoản</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link th:href="@{/css/register.css}" rel="stylesheet"/>
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}">
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}">
    <link rel="stylesheet" th:href="@{/css/complete.css}">
</head>
<body>
<div class="backdrop">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
        <button class="close" onclick="location.href='/'" aria-label="Đóng"></button>

        <img class="logo" src="/images/coolclub-logo.avif" alt="COOL CLUB"/>
        <h1 class="title" id="dlg-title">Cập nhật Tài khoản của Bạn</h1>
        <p class="sub">Vui lòng thêm số điện thoại để tăng cường bảo mật và nhận ưu đãi đặc biệt nhé!</p>

        <!-- DÙNG đường dẫn tuyệt đối để chắc chắn POST đúng -->
        <form action="/api/profile/complete" method="post" id="completeForm" novalidate>
            <input th:if="${_csrf != null}"
                   type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>
            <div class="row mb-3">
                <input class="inp" type="text" th:value="${user.fullname}" readonly placeholder="Họ và tên"/>
                <input class="inp" type="tel" id="phone" name="phone"
                       placeholder="Số điện thoại" inputmode="numeric" pattern="[0-9]{9,11}"
                       autocomplete="tel" required/>
            </div>
            <div class="mb-3">
                <input class="inp" type="email" th:value="${user.email}" readonly placeholder="Email"/>
            </div>

            <!-- BAN ĐẦU disable -->
            <button class="btn" id="submitBtn" type="submit" disabled>CẬP NHẬT</button>
        </form>
    </div>
</div>
<!-- Modal -->
<div id="appModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Thông báo</h3>
        </div>
        <div class="modal-body" id="modalBody">...</div>
        <div class="modal-actions">
            <button type="button" class="btn-ghost" id="modalCancel" style="display:none">Hủy</button>
            <button type="button" class="btn" id="modalOk">OK</button>
        </div>
    </div>
</div>
<script>
    (() => {
        // ===== DOM =====
        const form = document.getElementById('completeForm');
        const ip   = document.getElementById('phone');
        const btn  = document.getElementById('submitBtn');

        const modalEl    = document.getElementById('appModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody  = document.getElementById('modalBody');
        const btnOk      = document.getElementById('modalOk');
        const btnCancel  = document.getElementById('modalCancel');
        let lastFocus = null;

        // ===== CSRF =====
        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

        // ===== Modal =====
        function openModal(message, {
            title='Thông báo', type='info', okText='OK', cancelText=null, onOk=null, onCancel=null
        } = {}) {
            lastFocus = document.activeElement;
            modalTitle.textContent = title;
            modalBody.textContent  = message;

            const box = modalEl.querySelector('.modal');
            box.classList.remove('modal--error','modal--success','modal--info');
            box.classList.add(`modal--${type}`);

            btnOk.textContent = okText || 'OK';
            btnOk.disabled = false;
            btnOk.setAttribute('aria-disabled','false');
            btnOk.onclick = () => { closeModal(); if (typeof onOk === 'function') onOk(); };

            if (cancelText) {
                btnCancel.style.display = '';
                btnCancel.textContent = cancelText;
                btnCancel.disabled = false;
                btnCancel.setAttribute('aria-disabled','false');
                btnCancel.onclick = () => { closeModal(); if (typeof onCancel === 'function') onCancel(); };
            } else {
                btnCancel.style.display = 'none';
                btnCancel.onclick = null;
            }

            modalEl.classList.add('show');
            modalEl.setAttribute('aria-hidden','false');
            btnOk.focus();
        }
        function closeModal(){
            modalEl.classList.remove('show');
            modalEl.setAttribute('aria-hidden','true');
            if (lastFocus && lastFocus.focus) lastFocus.focus();
        }
        window.addEventListener('keydown', e => {
            if (e.key === 'Escape' && modalEl.classList.contains('show')) closeModal();
        });
        modalEl.addEventListener('click', e => { if (e.target === modalEl) closeModal(); });

        const alertInfo    = (msg, opts={}) => openModal(msg, { type:'info',    title: opts.title || 'Thông báo', ...opts });
        const alertError   = (msg, opts={}) => openModal(msg, { type:'error',   title: opts.title || 'Lỗi', ...opts });
        const alertSuccess = (msg, opts={}) => openModal(msg, { type:'success', title: opts.title || 'Thành công', ...opts });

        // ===== Validate & duplicate check =====
        // Muốn đủ 10 số thì bật: dùng regex 10 số (nhớ đổi pattern input nếu cần)
        const validPhone = v => /^\d{10}$/.test((v||'').trim());

        let debounce, lastVal='', lastShownDup='', cachedOK=null;

        function applyFormatState() {
            const v = (ip.value || '').trim();
            const ok = validPhone(v);
            btn.disabled = !ok;
            btn.classList.toggle('enabled', ok);
            return ok;
        }

        // options: { showModal?: boolean, forceModal?: boolean }
        async function checkPhone(options = {}) {
            const { showModal = false, forceModal = false } = options;
            const v = (ip.value || '').trim();

            const okFormat = applyFormatState();
            if (!okFormat){ cachedOK = null; return null; }

            if (v === lastVal && cachedOK !== null) {
                // Vẫn trả về cache nhưng nếu submit + forceModal và là trùng, vẫn show modal
                if (showModal && forceModal && cachedOK === false) {
                    alertError('Số điện thoại này đã được đăng ký. Vui lòng dùng số khác.', { title: 'Số điện thoại bị trùng' });
                }
                return cachedOK;
            }
            lastVal = v;

            try{
                const r = await fetch(`/api/profile/phone-exists?phone=${encodeURIComponent(v)}`, {
                    method: 'GET', credentials: 'include'
                });
                const data = await r.json().catch(()=> ({}));

                if (data.exists === true){
                    btn.disabled = true;
                    btn.classList.remove('enabled');
                    if (showModal && (forceModal || lastShownDup !== v)){
                        lastShownDup = v;
                        alertError('Số điện thoại này đã được đăng ký. Vui lòng dùng số khác.', { title: 'Số điện thoại bị trùng' });
                    }
                    cachedOK = false; return false;
                }
                if (data.valid === false){
                    btn.disabled = true;
                    btn.classList.remove('enabled');
                    if (showModal){
                        alertError('Số điện thoại không hợp lệ.', { title: 'Không hợp lệ' });
                    }
                    cachedOK = false; return false;
                }

                btn.disabled = false;
                btn.classList.add('enabled');
                cachedOK = true; return true;
            }catch(e){
                console.warn('phone-exists error', e);
                // lỗi mạng -> vẫn cho submit, BE kiểm lại
                cachedOK = true; return true;
            }
        }

        // ===== Events =====
        ip.addEventListener('input', () => {
            const ok = applyFormatState();
            clearTimeout(debounce);
            if (ok) debounce = setTimeout(() => checkPhone({ showModal:false }), 300);
            else cachedOK = null;
        });

        ip.addEventListener('blur', () => { if (applyFormatState()) checkPhone({ showModal:true }); });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!applyFormatState()) return;

            // ⬇️ Ép hiện modal nếu trùng, ngay cả khi đã hiện trước đó
            const ok = await checkPhone({ showModal:true, forceModal:true });
            if (ok === false) return;

            const body = new URLSearchParams(new FormData(form));
            btn.disabled = true;
            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        ...(CSRF_TOKEN ? { [CSRF_HEADER]: CSRF_TOKEN } : {})
                    },
                    body,
                    credentials: 'include'
                });

                if (res.ok) {
                    alertSuccess('Cập nhật thành công!', { onOk: () => location.href = '/auth/complete/intro' });
                } else if (res.status === 409) {
                    alertError('Số điện thoại này đã được đăng ký. Vui lòng dùng số khác.', { title: 'Số điện thoại bị trùng' });
                } else if (res.status === 400) {
                    const t = await res.text().catch(()=> '');
                    alertError(t || 'Dữ liệu không hợp lệ.', { title: 'Không hợp lệ' });
                } else if (res.status === 401) {
                    alertError('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.', { title: 'Cần đăng nhập' });
                } else {
                    const t = await res.text().catch(()=> '');
                    alertError(t || 'Lỗi máy chủ. Vui lòng thử lại sau.', { title: 'Lỗi' });
                }
            } catch (err) {
                console.error(err);
                alertError('Không thể kết nối máy chủ. Vui lòng kiểm tra mạng và thử lại.', { title: 'Mạng lỗi' });
            } finally {
                btn.disabled = !validPhone((ip.value||'').trim());
                btn.classList.toggle('enabled', !btn.disabled);
            }
        });

        // Init: set UI (không gọi BE, không bật modal)
        applyFormatState();
    })();
</script>

</body>
</html>
