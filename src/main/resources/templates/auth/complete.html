<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Cập nhật tài khoản</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link th:href="@{/css/register.css}" rel="stylesheet"/>
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}">
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}">

    <style>
        :root { --font-ui:"Segoe UI", Roboto, Arial, sans-serif; }
        html,body{ font-family:var(--font-ui); font-weight:400; margin:0 }
        .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:24px }
        .card{ width:min(640px, calc(100% - 32px)); background:#fff; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.15); position:relative; padding:28px }
        .close{ position:absolute; right:-14px; top:-14px; width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:#000; color:#fff; border:4px solid #fff; cursor:pointer; line-height:0; font-size:0; box-shadow:0 8px 18px rgba(0,0,0,.25) }
        .close::before,.close::after{ content:""; position:absolute; left:50%; top:50%; width:18px; height:2px; background:#fff; border-radius:2px; transform-origin:center center }
        .close::before{ transform:translate(-50%,-50%) rotate(45deg) }
        .close::after{ transform:translate(-50%,-50%) rotate(-45deg) }
        .logo{ height:28px }
        .title{ margin:12px 0 8px; font-size:44px; line-height:1.05; font-weight:600; letter-spacing:-.02em }
        .sub{ color:#4b5563; margin:6px 0 18px; font-weight:400 }
        .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
        .inp{ height:52px; width:100%; border-radius:999px; border:1px solid #d1d5db; padding:0 16px; font-size:16px; outline:none; box-sizing:border-box }
        .inp:read-only{ background:#f3f4f6 }
        .mb-3{ margin-bottom:14px }
        .btn{ width:100%; height:56px; border-radius:999px; border:0; font-weight:600; font-size:16px; cursor:not-allowed; background:#e5e5e5; color:#9a9a9a }
        .btn.enabled{ cursor:pointer; background:#111; color:#fff }
        @media (max-width:520px){ .row{ grid-template-columns:1fr } .title{ font-size:34px } }
    </style>
</head>
<body>
<div class="backdrop">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
        <button class="close" onclick="location.href='/'" aria-label="Đóng"></button>

        <img class="logo" src="/images/coolclub-logo.avif" alt="COOL CLUB"/>
        <h1 class="title" id="dlg-title">Cập nhật Tài khoản của Bạn</h1>
        <p class="sub">Vui lòng thêm số điện thoại để tăng cường bảo mật và nhận ưu đãi đặc biệt nhé!</p>

        <!-- DÙNG đường dẫn tuyệt đối để chắc chắn POST đúng -->
        <form action="/auth/complete/phone" method="post" id="completeForm" novalidate>
            <input th:if="${_csrf != null}"
                   type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>
            <div class="row mb-3">
                <input class="inp" type="text" th:value="${user.fullname}" readonly placeholder="Họ và tên"/>
                <input class="inp" type="tel" id="phone" name="phone"
                       placeholder="Số điện thoại" inputmode="numeric" pattern="[0-9]{9,11}"
                       autocomplete="tel" required/>
            </div>
            <div class="mb-3">
                <input class="inp" type="email" th:value="${user.email}" readonly placeholder="Email"/>
            </div>

            <!-- BAN ĐẦU disable -->
            <button class="btn" id="submitBtn" type="submit" disabled>CẬP NHẬT</button>
        </form>
    </div>
</div>

<script>
    const form = document.getElementById('completeForm');
    const ip   = document.getElementById('phone');
    const btn  = document.getElementById('submitBtn');

    const validPhone = v => /^\d{9,11}$/.test(v.trim());

    // Bật/tắt nút theo input
    const toggle = () => {
        const ok = validPhone(ip.value);
        btn.disabled = !ok;
        btn.classList.toggle('enabled', ok); // chỉ đổi màu
    };
    ip.addEventListener('input', toggle);
    toggle();

    // ÉP SUBMIT để tránh bất kỳ script global nào đã preventDefault
    btn.addEventListener('click', (e) => {
        if (btn.disabled) { e.preventDefault(); return; } // chưa hợp lệ => không gửi
        form.submit();                                    // gửi thật sự
    });
</script>
</body>
</html>
