<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒêƒÉng k√Ω t√†i kho·∫£n</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/register.css}">
    <style>
        .error { color:#d00; text-align:center; margin:8px 0 }
        .hidden { display:none }
    </style>
</head>
<body>
<div class="backdrop">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
        <button class="close" onclick="window.location.href='/'" aria-label="ƒê√≥ng"></button>

        <div class="logo-row">
            <img class="logo" src="/images/coolclub-logo.avif" alt="COOL CLUB">
        </div>

<!--        <h1 class="title" id="dlg-title">R·∫•t nhi·ªÅu ƒë·∫∑c quy·ªÅn v√† quy·ªÅn l·ª£i mua s·∫Øm ƒëang ch·ªù b·∫°n</h1>-->
        <div class="muted">Quy·ªÅn l·ª£i d√†nh ri√™ng cho b·∫°n khi tham gia Coolclub</div>

        <div class="perks">
            <div class="perk"><img src="/images/perk-voucher.avif" alt="Voucher ∆∞u ƒë√£i"><div><strong>Voucher ∆∞u ƒë√£i</strong></div></div>
            <div class="perk"><img src="/images/perk-gift.avif" alt="Qu√† t·∫∑ng ƒë·ªôc quy·ªÅn"><div><strong>Qu√† t·∫∑ng ƒë·ªôc quy·ªÅn</strong></div></div>
            <div class="perk"><img src="/images/perk-cash.avif" alt="Ho√†n ti·ªÅn CoolCash"><div><strong>Ho√†n ti·ªÅn CoolCash</strong></div></div>
        </div>

        <div class="section-label">ƒêƒÉng k√Ω t√†i kho·∫£n (mi·ªÖn ph√≠)</div>

        <div class="socials">
            <a class="social-btn" href="#" id="btnGoogle" title="ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p Google">
                <img src="/images/ic-google.png" alt="Google">
            </a>
            <a class="social-btn" href="#" id="btnFacebook" title="ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p Facebook">
                <img src="/images/ic-facebook.png" alt="Facebook">
            </a>
        </div>
        <p class="error hidden" id="errGoogle">ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i.</p>
        <p class="error hidden" id="errFacebook">ƒêƒÉng nh·∫≠p Facebook th·∫•t b·∫°i.</p>

        <div class="or">Ho·∫∑c</div>

        <!-- REGISTER FORM (g·ªçi API, kh√¥ng post MVC) -->
        <form id="registerForm" novalidate>
            <div class="float-field">
                <input class="float-input" type="text" name="fullName" id="fullName" placeholder=" " required minlength="2" maxlength="100">
                <label class="float-label" for="fullName">H·ªç v√† t√™n</label>
            </div>

            <div class="row-2">
                <div class="float-field">
                    <input class="float-input" type="tel" name="phone" id="phone" placeholder=" "
                           pattern="^[0-9]{9,11}$" required>
                    <label class="float-label" for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                </div>
                <div class="float-field">
                    <input class="float-input" type="email" name="email" id="email" placeholder=" " required>
                    <label class="float-label" for="email">Email</label>
                </div>
            </div>

            <div class="float-field">
                <input class="float-input" type="password" name="password" id="pwd" placeholder=" " required minlength="6">
                <label class="float-label" for="pwd">M·∫≠t kh·∫©u</label>
                <span class="toggle-eye" data-target="pwd">üëÅ</span>
            </div>

            <div class="float-field">
                <input class="float-input" type="password" name="confirmPassword" id="pwd2" placeholder=" " required minlength="6">
                <label class="float-label" for="pwd2">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <span class="toggle-eye" data-target="pwd2">üëÅ</span>
            </div>
            <small id="pwdHint" class="muted"></small>

            <label class="agree">
                <input type="checkbox" name="agree" id="agree" required>
                <span>T√¥i ƒë·ªìng √Ω v·ªõi <a th:href="@{/terms}">ƒêi·ªÅu kho·∫£n</a> &amp; <a th:href="@{/privacy}">Ch√≠nh s√°ch</a>.</span>
            </label>

            <!-- reCAPTCHA v2 checkbox: ·∫®N L√öC ƒê·∫¶U, render khi b·∫•m ƒêƒÉng k√Ω -->
            <div id="captchaWrap" class="hidden" style="margin-top:12px">
                <div id="captcha"
                     th:attr="data-sitekey=${@environment.getProperty('app.recaptcha.site-key')}"></div>
                <small class="muted">Vui l√≤ng x√°c nh·∫≠n ƒë·ªÉ ho√†n t·∫•t ƒëƒÉng k√Ω.</small>
            </div>

            <p class="error hidden" id="errRegister"></p>

            <button class="btn btn-primary" type="submit" id="btnSubmit">ƒêƒÇNG K√ù T√ÄI KHO·∫¢N</button>
        </form>

        <div class="links">
            <span>ƒê√£ c√≥ t√†i kho·∫£n? <a th:href="@{/auth/login}">ƒêƒÉng nh·∫≠p</a></span>
            <a th:href="@{/auth/forgot}">Qu√™n m·∫≠t kh·∫©u</a>
        </div>
    </div>
</div>
<!-- ===== Modal (popup) ===== -->
<div id="appModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Th√¥ng b√°o</h3>
        </div>
        <div class="modal-body" id="modalBody">N·ªôi dung th√¥ng b√°o‚Ä¶</div>
        <div class="modal-actions">
            <button type="button" class="btn-ghost" id="modalCancel" style="display:none">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="modalOk">OK</button>
        </div>
    </div>
</div>

<!-- ===== Helpers & form logic ===== -->
<script>
    // helpers
    const $ = (s) => document.querySelector(s);
    const show = el => el?.classList?.remove('hidden');
    const hide = el => el?.classList?.add('hidden');

    // toggle eye
    document.querySelectorAll('.toggle-eye').forEach(el=>{
        el.addEventListener('click', ()=>{
            const id = el.getAttribute('data-target');
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        });
    });

    // strength hint
    const pwd = document.getElementById('pwd'), hint = document.getElementById('pwdHint');
    pwd.addEventListener('input', ()=>{
        const v=pwd.value;
        const score=(v.length>=8)+/[A-Z]/.test(v)+/[a-z]/.test(v)+/[0-9]/.test(v)+/[^A-Za-z0-9]/.test(v);
        hint.textContent=['R·∫•t y·∫øu','Y·∫øu','Trung b√¨nh','Kh√°','M·∫°nh','R·∫•t m·∫°nh'][score]||'';
    });

    // ==== reCAPTCHA explicit render (·∫©n tr∆∞·ªõc, ch·ªâ render khi b·∫•m n√∫t) ====
    let recaptchaReady=false, recaptchaWidgetId=null, captchaToken='';
    function onRecaptchaReady(){ recaptchaReady = true; } // ƒë∆∞·ª£c g·ªçi khi SDK load xong
    function renderCaptchaIfNeeded(){
        show(document.getElementById('captchaWrap'));
        if (recaptchaWidgetId !== null) return;
        const doRender = () => {
            const el = document.getElementById('captcha');
            const sitekey = el.dataset.sitekey;
            recaptchaWidgetId = grecaptcha.render('captcha', {
                sitekey,
                callback: function(token){ captchaToken = token; }
            });
            // focus v√†o captcha
            setTimeout(()=> document.getElementById('captcha').scrollIntoView({behavior:'smooth', block:'center'}), 50);
        };
        if (recaptchaReady) doRender();
        else {
            // ch·ªù SDK s·∫µn s√†ng
            let n=0; const t=setInterval(()=>{
                if (recaptchaReady){ clearInterval(t); doRender(); }
                if (++n>50){ clearInterval(t); } // 5s timeout
            },100);
        }
    }

    // submit -> n·∫øu ch∆∞a c√≥ token th√¨ hi·ªán captcha; c√≥ r·ªìi th√¨ g·ªçi API
    const form = document.getElementById('registerForm');
    const err = document.getElementById('errRegister');
    form.addEventListener('submit', async (e)=>{
        e.preventDefault(); hide(err);

        // client checks
        const p1 = document.getElementById('pwd').value.trim();
        const p2 = document.getElementById('pwd2').value.trim();
        if(p1 !== p2){ alertError('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp.', { title: 'L·ªói' });
            return;
        }
        if(!document.getElementById('agree').checked){ alertError('B·∫°n ph·∫£i ƒë·ªìng √Ω v·ªõi ƒêi·ªÅu kho·∫£n & Ch√≠nh s√°ch.', { title: 'L·ªói' });
return; }

        // ch∆∞a c√≥ token -> hi·ªán/render captcha & y√™u c·∫ßu ng∆∞·ªùi d√πng tick
        if(!captchaToken){
            renderCaptchaIfNeeded();
            // n·∫øu ƒë√£ render r·ªìi nh∆∞ng ch∆∞a tick, nh·∫Øc l·ªói
            const respNow = (window.grecaptcha && recaptchaWidgetId!=null) ? grecaptcha.getResponse(recaptchaWidgetId) : '';
            if(!respNow){alertInfo('Vui l√≤ng x√°c nh·∫≠n Captcha.', {
                title: 'X√°c nh·∫≠n b·∫£o m·∫≠t',
                onOk: () => {
                    renderCaptchaIfNeeded();
                    document.getElementById('captcha').scrollIntoView({behavior:'smooth', block:'center'});
                }
            });
                return; }
            // khi ng∆∞·ªùi d√πng v·ª´a tick xong, callback s·∫Ω set captchaToken ‚Üí l·∫ßn submit ti·∫øp theo s·∫Ω ƒëi ti·∫øp
            return;
        }

        // c√≥ token r·ªìi -> g·ªçi API
        const btn = document.getElementById('btnSubmit'); btn.disabled = true;
        const body = {
            email:    $('#email').value.trim(),
            password: p1,
            fullname: $('#fullName').value.trim(),
            phone:    $('#phone').value.trim(),
            recaptchaToken: captchaToken
        };

        try{
            const resp = await fetch('/api/auth/register', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
            });
            const text = await resp.text();
            if(!resp.ok){
                alertError((text && text.length<200)?text:'ƒêƒÉng k√Ω th·∫•t b·∫°i.', { title: 'ƒêƒÉng k√Ω th·∫•t b·∫°i' });
                if(window.grecaptcha && recaptchaWidgetId!=null){ grecaptcha.reset(recaptchaWidgetId); captchaToken=''; }
                return;
            }
            const go = () => location.href = '/auth/complete/intro';
            const timer = setTimeout(go, 3000);
            alertSuccess('ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y.', {
                title: 'Th√†nh c√¥ng',
                okText: 'ƒêi ngay',
                onOk: () => { clearTimeout(timer); go(); }
            });

        }catch(ex){
            alertError('L·ªói m·∫°ng khi ƒëƒÉng k√Ω. Vui l√≤ng th·ª≠ l·∫°i.', { title: 'L·ªói m·∫°ng' });
            if(window.grecaptcha && recaptchaWidgetId!=null){ grecaptcha.reset(recaptchaWidgetId); captchaToken=''; }
            console.error(ex);
        }finally{
            btn.disabled=false;
        }
    });
</script>

<!-- reCAPTCHA SDK: explicit render + onload callback -->
<script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaReady&render=explicit" async defer></script>

<!-- ===== Social (FB & Google) v·∫´n ·∫©n captcha, d√πng l·∫°i flow ƒëƒÉng nh·∫≠p ===== -->
<!-- FB SDK -->
<div id="fb-root"></div>
<script>
    const fbReady = new Promise(resolve => {
        window.fbAsyncInit = function () {
            FB.init({ appId: '1495990908193900', cookie: true, xfbml: false, version: 'v19.0' });
            console.log('[FB] SDK ready'); resolve(true);
        };
    });
    (function(d,s,id){ if(d.getElementById(id))return; const js=d.createElement(s);
        js.id=id; js.async=true; js.defer=true; js.crossOrigin='anonymous';
        js.src='https://connect.facebook.net/vi_VN/sdk.js';
        d.getElementsByTagName('head')[0].appendChild(js);
    })(document,'script','facebook-jssdk');
</script>

<!-- Google GSI -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
    const GSI_CLIENT_ID='96998956369-8pvvqgj35agmp1jlon8iectgsdkhdptn.apps.googleusercontent.com';
    function waitGSI(){ return new Promise((res,rej)=>{let n=0,t=setInterval(()=>{n++;
        if(window.google?.accounts?.id){clearInterval(t);res();}
        if(n>50){clearInterval(t);rej(new Error('GSI not loaded'));}},100);});
    }

    async function handleRegisterResult(resp, errEl){
        let text=''; try{ text=await resp.text(); }catch{}
        if(!resp.ok){
            if(errEl){ errEl.classList.remove('hidden'); errEl.textContent=(text&&text.length<200)?text:'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.'; }
            console.error('Auth error:', resp.status, text);
            return false;
        }
        let data={}; try{ data=text?JSON.parse(text):{}; }catch{}
        if(data.accessToken)  localStorage.setItem('accessToken',  data.accessToken);
        if(data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);

        // G·ªçi /api/me ƒë·ªÉ xem ƒë√£ c√≥ phone ch∆∞a
        try{
            const meResp = await fetch('/api/me', {
                method: 'GET',
                headers: {
                    'Authorization': data.accessToken ? `Bearer ${data.accessToken}` : ''
                },
                credentials: 'include'
            });
            if(meResp.ok){
                const me = await meResp.json();
                if (me?.phone) {
                    alertSuccess('ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', {
                        title: 'Th√†nh c√¥ng',
                        onOk: () => { location.href = '/auth/complete/intro'; }
                    });
                } else {
                    location.href = '/auth/complete';
                }
                return true;
            }
        }catch(e){ console.warn('Cannot fetch /api/me', e); }

        // fallback n·∫øu /api/me l·ªói
        location.href = '/auth/complete';
        return true;
    }

    async function initGoogle() {
        try{
            await waitGSI();
            google.accounts.id.initialize({
                client_id: GSI_CLIENT_ID,
                callback: async ({credential}) => {
                    const resp = await fetch('/api/auth/google', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ idToken: credential })
                    });
                    await handleRegisterResult(resp, document.getElementById('errGoogle'));
                }
            });
            const btn = document.getElementById('btnGoogle');
            btn.innerHTML=''; btn.style.padding='0'; btn.style.border='none'; btn.style.background='transparent';
            btn.style.display='inline-flex'; btn.style.alignItems='center'; btn.style.justifyContent='center';
            google.accounts.id.renderButton(btn, { type:'icon', theme:'outline', size:'large', shape:'circle' });
        }catch(e){
            const el = document.getElementById('errGoogle');
            alertError('Kh√¥ng t·∫£i ƒë∆∞·ª£c Google Identity.', { title: 'L·ªói Google' });

            console.error(e);
        }
    }
    window.addEventListener('load', initGoogle);

    // Facebook button
    const errFacebook = document.getElementById('errFacebook');
    document.getElementById('btnFacebook')?.addEventListener('click', async (e) => {
        e.preventDefault(); errFacebook.classList.add('hidden');
        try {
            await fbReady;
            FB.login((response) => {
                (async () => {
                    const t = response?.authResponse?.accessToken;
                    if (response.status === 'connected' && t) {
                        const resp = await fetch('/api/auth/facebook', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accessToken: t })
                        });
                        await handleRegisterResult(resp, errFacebook);
                    } else {
                        alertError('ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.', { title: 'L·ªói Facebook' });
                    }
                })().catch(ex => {
                    alertError('ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.', { title: 'L·ªói Facebook' });
                });
            }/*, { scope:'email', return_scopes:true }*/);
        } catch (ex) {
            alertError('ƒêƒÉng nh·∫≠p Facebook b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i.', { title: 'L·ªói Facebook' });
        }
    });
</script>
<script>
    // === Modal helpers ===
    const modalEl = document.getElementById('appModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody  = document.getElementById('modalBody');
    const btnOk      = document.getElementById('modalOk');
    const btnCancel  = document.getElementById('modalCancel');
    let lastFocus = null;

    function openModal(message, { title='Th√¥ng b√°o', type='info', okText='OK', cancelText=null, onOk=null, onCancel=null } = {}) {
        lastFocus = document.activeElement;

        modalTitle.textContent = title;
        modalBody.textContent = message;

        modalEl.classList.remove('modal--error','modal--success','modal--info');
        modalEl.classList.add(`modal--${type}`);


        btnOk.textContent = okText || 'OK';
        btnOk.onclick = () => {
            closeModal();
            if (typeof onOk === 'function') onOk();
        };

        if (cancelText) {
            btnCancel.style.display = '';
            btnCancel.textContent = cancelText;
            btnCancel.onclick = () => {
                closeModal();
                if (typeof onCancel === 'function') onCancel();
            };
        } else {
            btnCancel.style.display = 'none';
            btnCancel.onclick = null;
        }

        modalEl.classList.add('show');
        modalEl.setAttribute('aria-hidden', 'false');
        btnOk.focus();
    }

    function closeModal() {
        modalEl.classList.remove('show');
        modalEl.setAttribute('aria-hidden', 'true');
        if (lastFocus && lastFocus.focus) lastFocus.focus();
    }

    // ƒê√≥ng khi b·∫•m ESC ho·∫∑c click ra ngo√†i
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalEl.classList.contains('show')) closeModal();
    });
    modalEl.addEventListener('click', (e) => {
        if (e.target === modalEl) closeModal();
    });

    // shortcut theo lo·∫°i
    const alertInfo    = (msg, opts={}) => openModal(msg, {type:'info',    title: opts.title || 'Th√¥ng b√°o', ...opts});
    const alertError   = (msg, opts={}) => openModal(msg, {type:'error',   title: opts.title || 'L·ªói', ...opts});
    const alertSuccess = (msg, opts={}) => openModal(msg, {type:'success', title: opts.title || 'Th√†nh c√¥ng', ...opts});
</script>

</body>
</html>
