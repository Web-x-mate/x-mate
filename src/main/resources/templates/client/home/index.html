<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/layout/base}">

<body>
  <!-- HEAD EXTRAS: CSS riêng cho trang Home -->
  <th:block layout:fragment="headExtras">
    <link rel="stylesheet" th:href="@{/client/css/home.css(v=${#dates.createNow().time})}" />
  </th:block>

  <!-- NỘI DUNG TRANG -->
  <div layout:fragment="content">
    <div class="home-banner full-bleed">
      <img class="home-banner__img"
          src="https://n7media.coolmate.me/uploads/October2025/Hero-Banner-rpp_63.jpg"
          alt="Hero Banner">
    </div>



    <div class="search-summary" th:if="${isSearch}">
      <div class="search-summary__container">
        <h1 class="search-summary__title">
          Kết quả cho
          "<span class="search-summary__keyword" th:text="${searchQuery}">từ khóa</span>"
        </h1>
        <p class="search-summary__meta" th:text="${searchTotal} + ' sản phẩm'">0 sản phẩm</p>
      </div>
    </div>

    <!-- render bằng fragment -->
    <section class="products" th:if="${products != null and !products.isEmpty()}">
      <div th:each="p : ${products}">
        <div th:replace="~{client/components/product-card :: productCard(product=${p})}"></div>
      </div>
    </section>

    <!-- PHÂN TRANG -->
    <div class="home-pagination" th:if="${pagination != null and pagination.totalPages > 1}">
      <nav class="home-pagination__nav" aria-label="Phân trang sản phẩm">
        <a class="home-pagination__control"
           th:href="@{/home(page=${pagination.previousPage}, size=${pagination.pageSize}, q=${searchQuery})}"
           th:attr="aria-disabled=${!pagination.hasPrevious()}"
           th:classappend="${!pagination.hasPrevious()} ? ' is-disabled' : ''">
          <span>Trước</span>
        </a>
        <ul class="home-pagination__list">
          <li th:each="num : ${pagination.pages}">
            <a class="home-pagination__page"
               th:text="${num}"
               th:href="@{/home(page=${num}, size=${pagination.pageSize}, q=${searchQuery})}"
               th:classappend="${num == pagination.currentPage} ? ' is-active' : ''">
            </a>
          </li>
        </ul>
        <a class="home-pagination__control"
           th:href="@{/home(page=${pagination.nextPage}, size=${pagination.pageSize}, q=${searchQuery})}"
           th:attr="aria-disabled=${!pagination.hasNext()}"
           th:classappend="${!pagination.hasNext()} ? ' is-disabled' : ''">
          <span>Sau</span>
        </a>
      </nav>
    </div>

    <div class="search-empty" th:if="${products == null or products.isEmpty()}">
      <span th:if="${isSearch}">Không tìm thấy sản phẩm phù hợp.</span>
      <span th:unless="${isSearch}">Chưa có sản phẩm nào.</span>
    </div>

    <!-- Inline debug + SWAP ẢNH (PRELOAD để đổi ngay, không nháy) -->
    <script>
      (function () {
        console.log('[HOME] debug inline script parsed');

        // Log init
        document.addEventListener('DOMContentLoaded', function () {
          var cards = document.querySelectorAll('.product-card');
          console.log('[HOME] DOMContentLoaded. cards=', cards.length);
          cards.forEach(function (c, i) {
            var act = c.querySelector('.swatch.is-active');
            if (act) console.log('[HOME] card#' + i, 'slug=', c.getAttribute('data-product-slug'), 'activeColor=', act.getAttribute('data-color'));
          });
        });

        // Helper: chuẩn hoá URL tương đối -> tuyệt đối
        function toAbs(u) {
          if (!u || typeof u !== 'string') return '';
          u = u.trim();
          if (!u) return '';
          if (/^https?:\/\//i.test(u) || u.startsWith('/')) return u;
          return '/' + u.replace(/^\/+/, '');
        }

        // Helper: mang theo tham số 'aio' (kích thước) của ảnh hiện tại
        function carryAioParam(fromUrl, toUrl) {
          try {
            var uFrom = new URL(fromUrl, window.location.origin);
            var uTo = new URL(toUrl, window.location.origin);
            var aio = uFrom.searchParams.get('aio');
            if (aio && !uTo.searchParams.get('aio')) {
              uTo.searchParams.set('aio', aio);
            }
            return uTo.toString();
          } catch (e) {
            return toUrl;
          }
        }

        // Event delegation
        document.addEventListener('click', function (e) {
          // click swatch (màu)
          var swatch = e.target.closest('.product-card .swatch');
          if (swatch) {
            var card1 = swatch.closest('.product-card');
            console.log('[CLICK COLOR]', {
              productSlug: card1 ? card1.getAttribute('data-product-slug') : null,
              color: swatch.getAttribute('data-color'),
              hex: swatch.getAttribute('data-color-hex'),
              variantId: swatch.getAttribute('data-variant-id'),
              image: swatch.getAttribute('data-color-image'),
              price: swatch.getAttribute('data-variant-price'),
              compare: swatch.getAttribute('data-variant-compare')
            });

            // set active để thấy đang chọn
            if (card1) {
              card1.querySelectorAll('.swatch.is-active').forEach(function (el) { el.classList.remove('is-active'); });
              swatch.classList.add('is-active');
              card1.setAttribute('data-selected-color', swatch.getAttribute('data-color') || '');
              card1.setAttribute('data-selected-variant', swatch.getAttribute('data-variant-id') || '');

              // === PRELOAD & SWAP MƯỢT (đổi ngay, không nháy) ===
              var img = card1.querySelector('.product-thumb'); // chỉ 1 ảnh chính
              var raw = (swatch.getAttribute('data-color-image') || '').trim();
              if (img && raw) {
                var urlAbs = toAbs(raw);

                // Dùng cùng tham số 'aio' với ảnh hiện tại để tránh reflow/giật
                var currentSrc = img.currentSrc || img.src || '';
                var urlWithAio = carryAioParam(currentSrc, urlAbs);

                // Thêm cache-buster để chắc chắn nạp
                var next = urlWithAio + (urlWithAio.includes('?') ? '&' : '?') + '_v=' + Date.now();

                // Ưu tiên tải ảnh mới
                img.setAttribute('loading', 'eager');
                img.setAttribute('fetchpriority', 'high');

                // Preload ảnh mới ở background → xong mới thay src
                var pre = new Image();
                pre.decoding = 'sync';
                pre.fetchPriority = 'high';
                pre.onload = function () {
                  // (optional) fade nhẹ cho mượt
                  img.style.transition = 'opacity .12s ease';
                  // thay src khi ảnh đã sẵn sàng → nhìn như đổi ngay
                  requestAnimationFrame(function () {
                    img.src = next;
                    card1.setAttribute('data-product-image', urlAbs);
                  });
                  console.log('[PRELOAD SWAP] ->', next);
                };
                pre.onerror = function () {
                  console.warn('[PRELOAD SWAP] load error, keep current');
                };
                pre.src = next;
              }
            }
            return;
          }

          // click size (Quick Add)
          var sizeBtn = e.target.closest('.product-card .quick-add__btn');
          if (sizeBtn) {
            var card2 = sizeBtn.closest('.product-card');
            console.log('[CLICK SIZE]', {
              productSlug: card2 ? card2.getAttribute('data-product-slug') : null,
              size: sizeBtn.getAttribute('data-size'),
              selectedVariant: card2 ? card2.getAttribute('data-selected-variant') : null,
              selectedColor: card2 ? card2.getAttribute('data-selected-color') : null
            });
            return;
          }
        });
      })();
    </script>

    <script>
      /**
       * Product Card interactions (inline on Home)
       * - Swap ảnh theo màu (swatch) ngay lập tức, có preload
       * - Giữ tham số `aio` từ ảnh hiện tại để ảnh mới đúng kích thước
       * - Cập nhật Quick Add & badge giỏ
       */
      (function () {
        // ===== Helpers =====
        function toAbs(u) {
          if (!u || typeof u !== 'string') return '';
          u = u.trim();
          if (!u) return '';
          if (/^https?:\/\//i.test(u) || u.startsWith('/')) return u;
          return '/' + u.replace(/^\/+/, '');
        }

        function carryAioParam(fromUrl, toUrl) {
          try {
            var uFrom = new URL(fromUrl, window.location.origin);
            var uTo = new URL(toUrl, window.location.origin);
            var aio = uFrom.searchParams.get('aio');
            if (aio && !uTo.searchParams.get('aio')) {
              uTo.searchParams.set('aio', aio);
            }
            return uTo.toString();
          } catch (e) {
            return toUrl;
          }
        }

        function updateCartBadge(count) {
          var cartBadge = document.querySelector('.cart__badge');
          if (!cartBadge) return;
          var n = Number.isFinite(+count) ? Math.max(0, Math.floor(+count)) : 0;
          if (n > 0) {
            cartBadge.textContent = String(n);
            cartBadge.style.display = '';
          } else {
            cartBadge.textContent = '';
            cartBadge.style.display = 'none';
          }
        }

        function ensureFeedback(card) {
          var wrap = card.querySelector('.quick-add');
          if (!wrap) return null;
          var el = wrap.querySelector('.quick-add__feedback');
          if (!el) {
            el = document.createElement('div');
            el.className = 'quick-add__feedback';
            wrap.appendChild(el);
          }
          return el;
        }

        function showFeedback(card, msg, isError) {
          var el = ensureFeedback(card);
          if (!el || !msg) return;
          el.textContent = msg;
          el.classList.toggle('is-error', !!isError);
          el.classList.add('is-visible');
          clearTimeout(el._t);
          el._t = setTimeout(function () { el.classList.remove('is-visible'); }, 2000);
        }

        function swapImageSmooth(img, nextAbsUrl) {
          // Giữ 'aio' từ ảnh hiện tại (để đúng ratio/size)
          var current = img.currentSrc || img.src || '';
          var withAio = carryAioParam(current, nextAbsUrl);

          // Cache-buster để chắc chắn nạp ảnh mới
          var next = withAio + (withAio.includes('?') ? '&' : '?') + '_v=' + Date.now();

          // Ưu tiên tải ảnh mới
          img.setAttribute('loading', 'eager');
          img.setAttribute('fetchpriority', 'high');

          // Preload → đổi src khi đã tải xong → nhìn “đổi ngay”, không nháy
          var pre = new Image();
          pre.decoding = 'sync';
          pre.fetchPriority = 'high';
          pre.onload = function () {
            // fade rất nhẹ cho mượt (tuỳ thích)
            img.style.transition = 'opacity .12s ease';
            requestAnimationFrame(function () {
              img.src = next;
            });
          };
          pre.onerror = function () {
            console.warn('[product-card:inline] preload error:', next);
          };
          pre.src = next;
        }

        // ===== Init lần đầu: cache ảnh mặc định + sync swatch active =====
        function initCardsOnce() {
          var cards = document.querySelectorAll('.product-card');
          cards.forEach(function (card) {
            if (card.__pcInlineInit) return;
            card.__pcInlineInit = true;

            var img = card.querySelector('.product-thumb');
            if (img && !img.dataset.originalSrc) {
              img.dataset.originalSrc = img.getAttribute('src') || '';
            }
            var def = img ? (img.dataset.originalSrc || img.getAttribute('src') || '') : '';
            if (def) {
              card.dataset.defaultImage = def;
              if (!card.getAttribute('data-product-image')) {
                card.setAttribute('data-product-image', def);
              }
            }

            // Nếu có swatch active, sync ngay các data & ảnh
            var active = card.querySelector('.swatch.is-active');
            if (active) {
              var color = active.getAttribute('data-color') || '';
              var vid = active.getAttribute('data-variant-id') || '';
              var url = active.getAttribute('data-color-image') || '';
              if (color) card.setAttribute('data-selected-color', color);
              if (vid) card.setAttribute('data-selected-variant', vid);
              if (img && url) {
                var abs = toAbs(url);
                swapImageSmooth(img, abs);
                card.setAttribute('data-product-image', abs);
              }
            }
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCardsOnce, { once: true });
        } else {
          initCardsOnce();
        }

        // ===== Event delegation: SWATCH CLICK =====
        document.addEventListener('click', function (e) {
          var sw = e.target.closest('.product-card .swatch');
          if (!sw) return;

          var card = sw.closest('.product-card');
          if (!card) return;

          // Toggle trạng thái chọn
          card.querySelectorAll('.swatch.is-active').forEach(function (el) { el.classList.remove('is-active'); });
          sw.classList.add('is-active');

          // Ghi lại select cho Quick Add
          var color = sw.getAttribute('data-color') || '';
          var vid = sw.getAttribute('data-variant-id') || '';
          var url = sw.getAttribute('data-color-image') || '';
          if (color) card.setAttribute('data-selected-color', color); else card.removeAttribute('data-selected-color');
          if (vid) card.setAttribute('data-selected-variant', vid); else card.removeAttribute('data-selected-variant');

          // Đổi ảnh ngay (preload trước, xong mới swap)
          var img = card.querySelector('.product-thumb');
          if (img && url) {
            var abs = toAbs(url);
            swapImageSmooth(img, abs);
            card.setAttribute('data-product-image', abs);
          }
        });

        // ===== Event delegation: QUICK ADD =====
        document.addEventListener('click', function (e) {
          var btn = e.target.closest('.product-card .quick-add__btn');
          if (!btn) return;

          var card = btn.closest('.product-card');
          if (!card) return;

          var size = btn.getAttribute('data-size');
          if (!size) {
            showFeedback(card, 'Vui lòng chọn size hợp lệ.', true);
            return;
          }

          var pid = card.getAttribute('data-product-id') || '';
          if (!pid) {
            showFeedback(card, 'Không tìm thấy mã sản phẩm.', true);
            return;
          }

          var payload = {
            productId: pid,
            slug: card.getAttribute('data-product-slug') || '',
            title: card.getAttribute('data-product-title') || '',
            price: Number(card.getAttribute('data-product-price') || 0),
            size: size,
            color: card.getAttribute('data-selected-color') || null,
            variantId: card.getAttribute('data-selected-variant') || null,
            quantity: 1,
            image: card.getAttribute('data-product-image') || ''
          };

          btn.disabled = true;
          btn.classList.add('is-loading');
          showFeedback(card, 'Đang thêm vào giỏ hàng...', false);

          fetch('/cart/items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify(payload)
          })
            .then(function (r) { return r.json().catch(function () { return {}; }).then(function (d) { return { ok: r.ok, data: d }; }); })
            .then(function (res) {
              if (res.ok && res.data && res.data.success) {
                updateCartBadge(res.data.cartQuantity);
                showFeedback(card, 'Đã thêm vào giỏ hàng!', false);
              } else {
                var msg = (res && res.data && res.data.message) || 'Không thể thêm vào giỏ hàng.';
                showFeedback(card, msg, true);
              }
            })
            .catch(function () {
              showFeedback(card, 'Có lỗi xảy ra. Vui lòng thử lại.', true);
            })
            .finally(function () {
              btn.disabled = false;
              btn.classList.remove('is-loading');
            });
        });
      })();
    </script>
  </div>

  <!-- BODY EXTRAS: JS riêng cho trang Home -->
  <th:block layout:fragment="bodyExtras">
    <!-- thêm version để chắc chắn load bản mới -->
    <script th:src="@{/client/js/product-card.js(v=${#dates.createNow().time})}"></script>
    <script th:src="@{/client/js/home.js(v=${#dates.createNow().time})}"></script>
  </th:block>
</body>

</html>
