<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/layout/base}">
<body>
<th:block layout:fragment="headExtras">
  <link rel="stylesheet" th:href="@{/client/css/home.css}"/>
</th:block>

<div layout:fragment="content">
  <div class="home-banner"></div>

  <div class="search-summary" th:if="${isSearch}">
    <div class="search-summary__container">
      <h1 class="search-summary__title">
        Kết quả cho
        "<span class="search-summary__keyword" th:text="${searchQuery}">từ khóa</span>"
      </h1>
      <p class="search-summary__meta" th:text="${searchTotal} + ' sản phẩm'">0 sản phẩm</p>
    </div>
  </div>

  <!-- render bằng fragment -->
  <section class="products" th:if="${products != null and !products.isEmpty()}">
    <div th:each="p : ${products}">
      <div th:replace="~{client/components/product-card :: productCard(product=${p})}"></div>
    </div>
  </section>

  <div class="search-empty" th:if="${products == null or products.isEmpty()}">
    <span th:if="${isSearch}">Không tìm thấy sản phẩm phù hợp.</span>
    <span th:unless="${isSearch}">Chưa có sản phẩm nào.</span>
  </div>

  <!-- Inline debug JS: log khi click màu & size trên nhiều card -->
  <script>
    (function () {
      console.log('[HOME] debug inline script parsed');

      // Log init: có bao nhiêu cards
      document.addEventListener('DOMContentLoaded', function () {
        var cards = document.querySelectorAll('.product-card');
        console.log('[HOME] DOMContentLoaded. cards=', cards.length);
        cards.forEach(function (c, i) {
          var act = c.querySelector('.swatch.is-active');
          if (act) console.log('[HOME] card#' + i, 'slug=', c.getAttribute('data-product-slug'), 'activeColor=', act.getAttribute('data-color'));
        });
      });

      // Event delegation
      document.addEventListener('click', function (e) {
        // click swatch (màu)
        var swatch = e.target.closest('.product-card .swatch');
        if (swatch) {
          var card1 = swatch.closest('.product-card');
          console.log('[CLICK COLOR]', {
            productSlug: card1 ? card1.getAttribute('data-product-slug') : null,
            color: swatch.getAttribute('data-color'),
            hex: swatch.getAttribute('data-color-hex'),
            variantId: swatch.getAttribute('data-variant-id'),
            image: swatch.getAttribute('data-color-image'),
            hoverImage: swatch.getAttribute('data-color-hover-image'),
            price: swatch.getAttribute('data-variant-price'),
            compare: swatch.getAttribute('data-variant-compare')
          });

          // set active để thấy đang chọn
          if (card1) {
            card1.querySelectorAll('.swatch.is-active').forEach(function (el) { el.classList.remove('is-active'); });
            swatch.classList.add('is-active');
            card1.setAttribute('data-selected-color', swatch.getAttribute('data-color') || '');
            card1.setAttribute('data-selected-variant', swatch.getAttribute('data-variant-id') || '');
          }
          return;
        }

        // click size (Quick Add)
        var sizeBtn = e.target.closest('.product-card .quick-add__btn');
        if (sizeBtn) {
          var card2 = sizeBtn.closest('.product-card');
          console.log('[CLICK SIZE]', {
            productSlug: card2 ? card2.getAttribute('data-product-slug') : null,
            size: sizeBtn.getAttribute('data-size'),
            selectedVariant: card2 ? card2.getAttribute('data-selected-variant') : null,
            selectedColor: card2 ? card2.getAttribute('data-selected-color') : null
          });
          return;
        }
      });
    })();
  </script>
</div>

<!-- Bạn có thể tắt 2 file JS ngoài khi đang test inline -->
<th:block layout:fragment="bodyExtras">
  <script th:src="@{/client/js/product-card.js}"></script>
  <script th:src="@{/client/js/home.js}"></script>
</th:block>
</body>
</html>
