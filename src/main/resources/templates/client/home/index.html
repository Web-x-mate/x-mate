<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/layout/base}">
<body>
<th:block layout:fragment="headExtras">
  <link rel="stylesheet" th:href="@{/client/css/home.css}"/>
</th:block>

<div layout:fragment="content" th:with="p=${(products != null and !products.isEmpty()) ? products[0] : null}">
  <div class="home-banner"></div>

  <div class="search-summary" th:if="${isSearch}">
    <div class="search-summary__container">
      <h1 class="search-summary__title">
        Kết quả cho
        "<span class="search-summary__keyword" th:text="${searchQuery}">từ khóa</span>"
      </h1>
      <p class="search-summary__meta" th:text="${searchTotal} + ' sản phẩm'">0 sản phẩm</p>
    </div>
  </div>

  <!-- CHỈ 1 SẢN PHẨM ĐẦU TIÊN -->
  <section class="products" th:if="${p != null}">
    <div class="product-card"
         th:attr="data-product-id=${p.slug},
                  data-product-slug=${p.slug},
                  data-product-title=${p.title},
                  data-product-price=${p.priceForCart},
                  data-product-image=${p.thumbnail != null ? p.thumbnail : '/images/product-placeholder.svg'}">

      <div class="thumb-wrap">
        <div class="thumb-ratio">
          <a class="product-link"
             th:href="@{/product/detail/{slug}(slug=${p.slug})}"
             th:aria-label="${p.title}">
            <img class="product-thumb"
                 th:src="${p.thumbnail}"
                 th:alt="${p.title}"
                 loading="lazy"/>
            <img class="product-thumb product-thumb--hover"
                 th:if="${p.hoverThumbnail != null}"
                 th:src="${p.hoverThumbnail}"
                 th:alt="${p.title}"
                 loading="lazy"/>
          </a>
        </div>

        <div class="quick-add"
             th:if="${p.sizes != null and !p.sizes.isEmpty()}"
             tabindex="0">
          <div class="quick-add__title">
            <span>Thêm vào giỏ hàng</span>
            <span class="quick-add__plus">+</span>
          </div>
          <div class="quick-add__sizes">
            <button class="quick-add__btn"
                    type="button"
                    th:each="size : ${p.sizes}"
                    th:text="${size}"
                    th:attr="data-size=${size}"></button>
          </div>
        </div>
      </div>

      <div class="swatches" th:if="${p.colors != null and !p.colors.isEmpty()}">
        <button class="swatch"
                type="button"
                th:each="color, iterStat : ${p.colors}"
                th:classappend="${iterStat.first} ? ' is-active' : ''"
                th:attr="data-color-name=${color['name']},
                         data-color=${color['name']},
                         data-color-hex=${color['hex']},
                         data-color-image=${color['image']},
                         data-color-hover-image=${color['hoverImage']},
                         data-variant-id=${color['variantId']},
                         data-variant-price=${color['price']},
                         data-variant-compare=${color['compareAt']}"
                th:style="${color['style']}">
          <span class="visually-hidden" th:text="${color['name']}">Màu</span>
        </button>
      </div>

      <div class="info">
        <a class="title"
           th:href="@{/product/detail/{slug}(slug=${p.slug})}"
           th:text="${p.title}">Sản phẩm</a>

        <div class="price-row">
          <span class="final"
                th:if="${p.finalPriceText != null}"
                th:text="${p.finalPriceText}">0&nbsp;₫</span>

          <span class="discount-pill"
                th:if="${p.hasDiscount and p.discountPercent > 0}"
                th:text="'-' + ${p.discountPercent} + '%'">-0%</span>

          <span class="old"
                th:if="${p.hasDiscount and p.originalPriceText != null}"
                th:text="${p.originalPriceText}">0&nbsp;₫</span>
        </div>
      </div>
    </div>
  </section>

  <div class="search-empty" th:if="${p == null}">
    <span th:if="${isSearch}">Không tìm thấy sản phẩm phù hợp.</span>
    <span th:unless="${isSearch}">Chưa có sản phẩm nào.</span>
  </div>

  <!-- JS INLINE Ở NGAY TRONG CONTENT ĐỂ CHẮC CHẮN ĐƯỢC RENDER -->
  <script>
    (function () {
      // Log ngay khi script được parse
      console.log('[HOME-ONE] inline debug script parsed');

      // Lắng nghe click ở DOCUMENT (event delegation)
      document.addEventListener('click', function (e) {
        var swatch = e.target.closest('.product-card .swatch');
        if (swatch) {
          var card1 = swatch.closest('.product-card');
          console.log('[CLICK COLOR]', {
            productSlug: card1 ? card1.getAttribute('data-product-slug') : null,
            color: swatch.getAttribute('data-color'),
            hex: swatch.getAttribute('data-color-hex'),
            variantId: swatch.getAttribute('data-variant-id'),
            image: swatch.getAttribute('data-color-image'),
            hoverImage: swatch.getAttribute('data-color-hover-image'),
            price: swatch.getAttribute('data-variant-price'),
            compare: swatch.getAttribute('data-variant-compare')
          });

          // set active cho dễ thấy
          if (card1) {
            card1.querySelectorAll('.swatch.is-active').forEach(function (el) { el.classList.remove('is-active'); });
            swatch.classList.add('is-active');
            card1.setAttribute('data-selected-color', swatch.getAttribute('data-color') || '');
            card1.setAttribute('data-selected-variant', swatch.getAttribute('data-variant-id') || '');
          }
          return;
        }

        var sizeBtn = e.target.closest('.product-card .quick-add__btn');
        if (sizeBtn) {
          var card2 = sizeBtn.closest('.product-card');
          console.log('[CLICK SIZE]', {
            productSlug: card2 ? card2.getAttribute('data-product-slug') : null,
            size: sizeBtn.getAttribute('data-size'),
            selectedVariant: card2 ? card2.getAttribute('data-selected-variant') : null,
            selectedColor: card2 ? card2.getAttribute('data-selected-color') : null
          });
          return;
        }
      });

      // Khi DOM sẵn sàng, log thêm tình trạng ban đầu
      document.addEventListener('DOMContentLoaded', function () {
        var card = document.querySelector('.product-card');
        if (!card) {
          console.log('[HOME-ONE] no product-card rendered');
          return;
        }
        console.log('[HOME-ONE] DOMContentLoaded, product slug:', card.getAttribute('data-product-slug'));

        var active = card.querySelector('.swatch.is-active');
        if (active) {
          console.log('[HOME-ONE] active color at init:', active.getAttribute('data-color'));
        }
      });
    })();
  </script>
</div>

<!-- (tùy) Nếu base layout của bạn có chỗ insert bodyExtras thì vẫn để block này -->
<th:block layout:fragment="bodyExtras">
  <!-- Có thể bỏ 2 file này đi trong giai đoạn test vì ta đã inline JS ở trên -->
  <!-- <script th:src="@{/client/js/product-card.js}"></script> -->
  <!-- <script th:src="@{/client/js/home.js}"></script> -->
</th:block>
</body>
</html>
