<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/layout/base}">
<body>
<th:block layout:fragment="headExtras">
  <link rel="stylesheet" th:href="@{/client/css/home.css}"/>
</th:block>

<div layout:fragment="content">
  <div class="home-banner"></div>

  <div class="search-summary" th:if="${isSearch}">
    <div class="search-summary__container">
      <h1 class="search-summary__title">
        Kết quả cho
        "<span class="search-summary__keyword" th:text="${searchQuery}">từ khóa</span>"
      </h1>
      <p class="search-summary__meta" th:text="${searchTotal} + ' sản phẩm'">0 sản phẩm</p>
    </div>
  </div>

  <!-- render bằng fragment -->
  <section class="products" th:if="${products != null and !products.isEmpty()}">
    <div th:each="p : ${products}">
      <div th:replace="~{client/components/product-card :: productCard(product=${p})}"></div>
    </div>
  </section>

  <div class="search-empty" th:if="${products == null or products.isEmpty()}">
    <span th:if="${isSearch}">Không tìm thấy sản phẩm phù hợp.</span>
    <span th:unless="${isSearch}">Chưa có sản phẩm nào.</span>
  </div>

  <!-- Inline debug + SWAP ẢNH (PRELOAD để đổi ngay, không nháy) -->
  <script>
    (function () {
      console.log('[HOME] debug inline script parsed');

      // Log init
      document.addEventListener('DOMContentLoaded', function () {
        var cards = document.querySelectorAll('.product-card');
        console.log('[HOME] DOMContentLoaded. cards=', cards.length);
        cards.forEach(function (c, i) {
          var act = c.querySelector('.swatch.is-active');
          if (act) console.log('[HOME] card#' + i, 'slug=', c.getAttribute('data-product-slug'), 'activeColor=', act.getAttribute('data-color'));
        });
      });

      // Helper: chuẩn hoá URL tương đối -> tuyệt đối
      function toAbs(u){
        if(!u || typeof u !== 'string') return '';
        u = u.trim();
        if (!u) return '';
        if (/^https?:\/\//i.test(u) || u.startsWith('/')) return u;
        return '/' + u.replace(/^\/+/, '');
      }

      // Helper: mang theo tham số 'aio' (kích thước) của ảnh hiện tại
      function carryAioParam(fromUrl, toUrl){
        try {
          var uFrom = new URL(fromUrl, window.location.origin);
          var uTo   = new URL(toUrl,   window.location.origin);
          var aio   = uFrom.searchParams.get('aio');
          if (aio && !uTo.searchParams.get('aio')) {
            uTo.searchParams.set('aio', aio);
          }
          return uTo.toString();
        } catch (e) {
          return toUrl;
        }
      }

      // Event delegation
      document.addEventListener('click', function (e) {
        // click swatch (màu)
        var swatch = e.target.closest('.product-card .swatch');
        if (swatch) {
          var card1 = swatch.closest('.product-card');
          console.log('[CLICK COLOR]', {
            productSlug: card1 ? card1.getAttribute('data-product-slug') : null,
            color: swatch.getAttribute('data-color'),
            hex: swatch.getAttribute('data-color-hex'),
            variantId: swatch.getAttribute('data-variant-id'),
            image: swatch.getAttribute('data-color-image'),
            price: swatch.getAttribute('data-variant-price'),
            compare: swatch.getAttribute('data-variant-compare')
          });

          // set active để thấy đang chọn
          if (card1) {
            card1.querySelectorAll('.swatch.is-active').forEach(function (el) { el.classList.remove('is-active'); });
            swatch.classList.add('is-active');
            card1.setAttribute('data-selected-color', swatch.getAttribute('data-color') || '');
            card1.setAttribute('data-selected-variant', swatch.getAttribute('data-variant-id') || '');

            // === PRELOAD & SWAP MƯỢT (đổi ngay, không nháy) ===
            var img  = card1.querySelector('.product-thumb'); // chỉ 1 ảnh chính
            var raw  = (swatch.getAttribute('data-color-image') || '').trim();
            if (img && raw) {
              var urlAbs = toAbs(raw);

              // Dùng cùng tham số 'aio' với ảnh hiện tại để tránh reflow/giật
              var currentSrc = img.currentSrc || img.src || '';
              var urlWithAio = carryAioParam(currentSrc, urlAbs);

              // Thêm cache-buster để chắc chắn nạp
              var next = urlWithAio + (urlWithAio.includes('?') ? '&' : '?') + '_v=' + Date.now();

              // Ưu tiên tải ảnh mới
              img.setAttribute('loading', 'eager');
              img.setAttribute('fetchpriority', 'high');

              // Preload ảnh mới ở background → xong mới thay src
              var pre = new Image();
              pre.decoding = 'sync';
              pre.fetchPriority = 'high';
              pre.onload = function(){
                // (optional) fade nhẹ cho mượt
                img.style.transition = 'opacity .12s ease';
                // thay src khi ảnh đã sẵn sàng → nhìn như đổi ngay
                requestAnimationFrame(function(){
                  img.src = next;
                  card1.setAttribute('data-product-image', urlAbs);
                });
                console.log('[PRELOAD SWAP] ->', next);
              };
              pre.onerror = function(){
                console.warn('[PRELOAD SWAP] load error, keep current');
              };
              pre.src = next;
            }
          }
          return;
        }

        // click size (Quick Add)
        var sizeBtn = e.target.closest('.product-card .quick-add__btn');
        if (sizeBtn) {
          var card2 = sizeBtn.closest('.product-card');
          console.log('[CLICK SIZE]', {
            productSlug: card2 ? card2.getAttribute('data-product-slug') : null,
            size: sizeBtn.getAttribute('data-size'),
            selectedVariant: card2 ? card2.getAttribute('data-selected-variant') : null,
            selectedColor: card2 ? card2.getAttribute('data-selected-color') : null
          });
          return;
        }
      });
    })();
  </script>
</div>

<!-- Bạn có thể tắt 2 file JS ngoài khi đang test inline -->
<th:block layout:fragment="bodyExtras">
  <!-- thêm version cho chắc chắn load bản mới (optional) -->
  <script th:src="@{/client/js/product-card.js(v=${T(java.lang.System).currentTimeMillis()})}"></script>
  <script th:src="@{/client/js/home.js(v=${T(java.lang.System).currentTimeMillis()})}"></script>
</th:block>
</body>
</html>
