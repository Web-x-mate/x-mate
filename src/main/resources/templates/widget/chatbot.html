<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <!-- N·∫øu trang n√†y render tr·ª±c ti·∫øp, 2 meta d∆∞·ªõi s·∫Ω ƒë∆∞·ª£c Thymeleaf fill.
         N·∫øu ch·ªâ nh√∫ng fragment v√†o layout kh√°c, h√£y ƒë·∫∑t 2 meta n√†y ·ªü layout ch√≠nh. -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>
<body>
<!-- Fragment c√≥ t√™n "widget" ƒë·ªÉ nh√∫ng -->
<div th:fragment="widget">
    <button type="button" class="sb-launcher" id="sbLauncher" aria-label="Open chat">üí¨</button>

    <div class="sb-panel" id="sbPanel" aria-live="polite">
        <div class="sb-header">
            ShopBot
            <span style="float:right; cursor:pointer" id="sbClose">‚úñ</span>
        </div>
        <div class="sb-body" id="sbMsgs"></div>
        <form class="sb-input" id="sbForm">
            <input type="text" id="sbQuestion" placeholder="Nh·∫≠p c√¢u h·ªèi..." required />
            <button type="submit">G·ª≠i</button>
        </form>
    </div>

    <script>
        (function () {
            const launcher = document.getElementById('sbLauncher');
            const panel = document.getElementById('sbPanel');
            const closeBtn = document.getElementById('sbClose');
            const form = document.getElementById('sbForm');
            const input = document.getElementById('sbQuestion');
            const msgs = document.getElementById('sbMsgs');

            function toggle(open) {
                if (open === true) panel.classList.add('open');
                else if (open === false) panel.classList.remove('open');
                else panel.classList.toggle('open');
                if (panel.classList.contains('open')) setTimeout(() => input.focus(), 50);
            }

            launcher.addEventListener('click', () => toggle());
            closeBtn.addEventListener('click', () => toggle(false));

            function escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            // üëâ Bi·∫øn URL trong text th√†nh <a> ‚Ä¶ </a>
            function linkify(text) {
                // tr∆∞·ªõc ti√™n escape ƒë·ªÉ tr√°nh XSS, r·ªìi m·ªõi thay th·∫ø URL
                const escaped = escapeHtml(text);
                // regex ƒë∆°n gi·∫£n nh·∫≠n http/https
                const urlRegex = /\bhttps?:\/\/[^\s<>"')]+/gi;
                return escaped.replace(urlRegex, (url) => {
                    // Hi·ªÉn th·ªã g·ªçn n·∫øu qu√° d√†i
                    const display = url.length > 80 ? url.slice(0, 77) + '‚Ä¶' : url;
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${display}</a>`;
                });
            }

            function addMsg(content, me = false, meta) {
                const wrap = document.createElement('div');
                wrap.className = 'msg' + (me ? ' me' : '');
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = content; // plain text
                wrap.appendChild(bubble);
                if (meta) {
                    const m = document.createElement('div');
                    m.className = 'meta';
                    m.textContent = meta;
                    wrap.appendChild(m);
                }
                msgs.appendChild(wrap);
                msgs.scrollTop = msgs.scrollHeight;
            }

            // üëâ Cho ph√©p ch√®n HTML ƒë√£ ‚Äúl√†m s·∫°ch‚Äù (t·ª´ linkify)
            function addMsgHtml(html, me = false, meta) {
                const wrap = document.createElement('div');
                wrap.className = 'msg' + (me ? ' me' : '');
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.innerHTML = html; // ch·ªâ d√πng v·ªõi output c·ªßa linkify()
                wrap.appendChild(bubble);
                if (meta) {
                    const m = document.createElement('div');
                    m.className = 'meta';
                    m.textContent = meta;
                    wrap.appendChild(m);
                }
                msgs.appendChild(wrap);
                msgs.scrollTop = msgs.scrollHeight;
            }

            // --- CSRF helper (C√°ch A) ---
            function getCookie(name) {
                return document.cookie
                    .split('; ')
                    .find(row => row.startsWith(name + '='))
                    ?.split('=')[1];
            }
            function buildCsrfHeaders() {
                const headers = { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' };
                const token  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                if (token && header) { headers[header] = token; return headers; }
                const xsrf = getCookie('XSRF-TOKEN');
                if (xsrf) headers['X-XSRF-TOKEN'] = decodeURIComponent(xsrf);
                return headers;
            }

            async function ask(q) {
                try {
                    const headers = buildCsrfHeaders();

                    // bubble "ƒëang g√µ‚Ä¶"
                    const loading = document.createElement('div');
                    loading.className = 'msg';
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    bubble.innerHTML = '<span class="dots"><span>.</span><span>.</span><span>.</span></span>';
                    loading.appendChild(bubble);
                    msgs.appendChild(loading);
                    msgs.scrollTop = msgs.scrollHeight;

                    const res = await fetch('/widget/chatbot/chat', {
                        method: 'POST',
                        headers,
                        body: new URLSearchParams({ question: q })
                    });

                    loading.remove();

                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json(); // ChatResponse

                    const txt = (data?.answer ?? '').toString();
                    // N·∫øu answer r·ªóng, show to√†n b·ªô JSON
                    const htmlAnswer = txt ? linkify(txt) : `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
                    addMsgHtml(htmlAnswer, false, data?.intent ? ('intent: ' + data.intent) : null);

                    // Passages -> hi·ªÉn th·ªã link n·∫øu c√≥
                    if (Array.isArray(data?.passages) && data.passages.length) {
                        const top = data.passages.slice(0, 3).map(p => {
                            const label = p?.slug || p?.url || p?.type || 'ngu·ªìn';
                            if (p?.url) {
                                const safeLabel = escapeHtml(label.toString());
                                return `<a href="${p.url}" target="_blank" rel="noopener noreferrer">${safeLabel}</a>`;
                            }
                            return escapeHtml(label.toString());
                        }).join(' | ');
                        addMsgHtml('Ngu·ªìn: ' + top, false);
                    }
                } catch (e) {
                    addMsg('L·ªói g·ªçi chatbot: ' + e.message, false);
                }
            }

            form.addEventListener('submit', function (ev) {
                ev.preventDefault();
                const q = input.value.trim();
                if (!q) return;
                addMsg(q, true);
                input.value = '';
                ask(q);
            });

            // toggle(true); // m·ªü s·∫µn n·∫øu mu·ªën
        })();
    </script>

</div>
</body>
</html>