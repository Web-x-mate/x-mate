
<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <meta charset="UTF-8">
    <title>Media</title>
    <style>
        :root{
            --bg:#f8fafc;
            --surface:#ffffff;
            --text:#0f172a;
            --muted:#64748b;
            --bd:#e2e8f0;
            --ring:#93c5fd;
            --primary:#2563eb;
            --primary-hover:#1d4ed8;
            --success:#16a34a;
            --success-hover:#15803d;
            --warning:#fbbf24;
            --danger:#ef4444;
            --danger-hover:#dc2626;
            --slate:#334155;
        }

        body{font-family:"Inter",system-ui,sans-serif;color:var(--text);background:var(--bg);}
        .wrap{max-width:1100px;margin:0 auto;padding:32px 0;}
        .page-title{font-size:1.9rem;font-weight:800;color:var(--text);text-align:center;margin:0 0 18px;}

        /* Toolbar */
        .toolbar{gap:10px;}
        .btn{
            height:40px;padding:0 14px;border-radius:12px;border:1px solid transparent;
            font-weight:700;font-size:.9rem;display:inline-flex;align-items:center;gap:.45rem;line-height:1;transition:.18s;
        }
        .btn-success{background:var(--success);color:#fff;border-color:var(--success);}
        .btn-success:hover{background:var(--success-hover);border-color:var(--success-hover);}
        .btn-outline-secondary{background:#fff;color:var(--slate);border:1px solid var(--bd);}
        .btn-outline-secondary:hover{background:#f1f5f9;}
        .btn-outline-primary{background:#fff;color:var(--primary);border:1px solid var(--primary);}
        .btn-outline-primary:hover{background:#eff6ff;}

        /* Card + Table */
        .table-card{background:var(--surface);border:1px solid var(--bd);border-radius:16px;box-shadow:0 2px 4px rgba(15,23,42,.06);}
        .table-responsive{max-height:70vh;overflow:auto;border-radius:16px;}
        table{width:100%;border-collapse:separate;border-spacing:0;font-size:.95rem;}
        thead th{
            position:sticky;top:0;z-index:2;background:#eef2f7;color:#0f172a;border-bottom:1px solid var(--bd);
            text-transform:uppercase;font-weight:800;font-size:.78rem;letter-spacing:.02em;
            padding:.75rem .95rem;white-space:nowrap;text-align:center;
        }
        tbody td{
            padding:.75rem .95rem;border-bottom:1px solid var(--bd);background:#fff;
            vertical-align:middle;text-align:center;
        }
        tbody tr:hover td{background:#f8fafc;}

        /* Bo góc bảng */
        thead th:first-child{border-top-left-radius:16px;}
        thead th:last-child{border-top-right-radius:16px;}
        tbody tr:last-child td:first-child{border-bottom-left-radius:16px;}
        tbody tr:last-child td:last-child{border-bottom-right-radius:16px;}

        /* Căn cột + URL truncate */
        .col-left{text-align:left;}
        .col-right{text-align:right;font-variant-numeric:tabular-nums;}
        .truncate{
            display:inline-block;max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;vertical-align:bottom;
        }

        /* Preview hình ảnh */
        .thumb{
            max-height:64px;max-width:100px;object-fit:cover;border-radius:10px;border:1px solid var(--bd);
            background:#fff;
        }

        /* Badge Primary */
        .badge{display:inline-flex;align-items:center;gap:.35rem;font-weight:800;border-radius:.55rem;padding:.3rem .55rem;font-size:.78rem;line-height:1;}
        .bg-success{background:var(--success);color:#fff;}
        .bg-secondary{background:#e2e8f0;color:#0f172a;}

        /* Action buttons (giữ class, chỉ tinh chỉnh) */
        .actions{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;}
        .btn-sm{
            height:34px;padding:0 12px;border-radius:10px;font-size:.82rem;font-weight:700;
            display:inline-flex;align-items:center;gap:.35rem;border:1px solid transparent;
        }
        .btn-warning{background:#fbbf24;color:#0f172a;border:none;}
        .btn-warning:hover{background:#f59e0b;}
        .btn-danger{background:var(--danger);color:#fff;border:none;}
        .btn-danger:hover{background:var(--danger-hover);}
        .btn-outline-success{background:#fff;color:var(--success);border:1px solid var(--success);}
        .btn-outline-success:hover{background:#ecfdf5;}

        @media (max-width:720px){
            .truncate{max-width:60vw;}
        }
    </style>
</head>
<body>
<section layout:fragment="content">

    <!-- Không có quyền VIEW -->
    <div class="alert alert-warning" sec:authorize="!hasAnyAuthority('PRODUCT_MEDIA_VIEW','ROLE_ADMIN')">
        Bạn không có quyền xem Media của sản phẩm này.
    </div>

    <!-- Có quyền VIEW -->
    <div sec:authorize="hasAnyAuthority('PRODUCT_MEDIA_VIEW','ROLE_ADMIN')" class="wrap">

        <h1 class="page-title" th:text="'Media - ' + ${product.name}">Media</h1>

        <!-- Toolbar -->
        <div class="toolbar d-flex align-items-center justify-content-between gap-2 mb-3">
            <div class="d-flex align-items-center gap-2">
                <a th:href="@{/admin/catalog/products}" class="btn btn-outline-secondary">← Quay lại Products</a>
                <a th:href="@{|/admin/catalog/products/${product.id}/edit|}" class="btn btn-outline-primary"
                   sec:authorize="hasAnyAuthority('PRODUCT_EDIT','ROLE_ADMIN')">Sửa Product</a>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a th:href="@{|/admin/catalog/products/${product.id}/media/new|}"
                   class="btn btn-success"
                   sec:authorize="hasAnyAuthority('PRODUCT_MEDIA_CREATE','ROLE_ADMIN')">+ Thêm Media</a>
            </div>
        </div>

        <!-- Table -->
        <div class="table-card">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle w-100">
                    <colgroup>
                        <col style="width:100px;">
                        <col style="width:120px;">
                        <col>
                        <col style="width:120px;">
                        <col style="width:100px;">
                        <col style="width:300px;">
                    </colgroup>
                    <thead class="table-light">
                    <tr>
                        <th>Preview</th>
                        <th>Type</th>
                        <th class="col-left">URL</th>
                        <th>Primary</th>
                        <th>Sort</th>
                        <th class="col-right">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="m : ${mediaPage?.content}">
                        <td>
                            <img th:if="${m.mediaType?.name() == 'IMAGE'}"
                                 th:src="${m.url}" alt="preview" class="thumb img-thumbnail">
                            <span th:if="${m.mediaType?.name() != 'IMAGE'}" th:text="${m.mediaType}">MEDIA</span>
                        </td>
                        <td th:text="${m.mediaType}">IMAGE</td>
                        <td class="col-left">
                            <a th:href="${m.url}" target="_blank" rel="noopener"
                               th:title="${m.url}" class="truncate" th:text="${m.url}">url</a>
                        </td>
                        <td>
              <span th:class="${m.primary} ? 'badge bg-success' : 'badge bg-secondary'"
                    th:text="${m.primary} ? 'Primary' : '—'">Primary</span>
                        </td>
                        <td th:text="${m.sortOrder}">0</td>
                        <td>
                            <div class="actions">
                                <!-- Make Primary -->
                                <form th:if="${!m.primary}"
                                      th:action="@{|/admin/catalog/products/${product.id}/media/${m.id}/make-primary|}"
                                      method="post"
                                      sec:authorize="hasAnyAuthority('PRODUCT_MEDIA_PRIMARY','ROLE_ADMIN')">
                                    <button type="submit" class="btn btn-sm btn-outline-success">Make Primary</button>
                                </form>

                                <!-- Edit -->
                                <a th:href="@{|/admin/catalog/products/${product.id}/media/edit/${m.id}|}"
                                   class="btn btn-sm btn-warning"
                                   sec:authorize="hasAnyAuthority('PRODUCT_MEDIA_EDIT','ROLE_ADMIN')">Edit</a>

                                <!-- Delete -->
                                <a th:href="@{|/admin/catalog/products/${product.id}/media/delete/${m.id}|}"
                                   onclick="return confirm('Xóa media này?');"
                                   class="btn btn-sm btn-danger"
                                   sec:authorize="hasAnyAuthority('PRODUCT_MEDIA_DELETE','ROLE_ADMIN')">Delete</a>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${mediaPage == null || #lists.isEmpty(mediaPage.content)}">
                        <td colspan="6" class="text-center" style="padding:18px;color:var(--muted);">No data</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div th:with="baseUrl=@{|/admin/catalog/products/${product.id}/media|}"
             th:replace="~{layout/components/_pagination :: body(page=${mediaPage}, baseUrl=${baseUrl})}"></div>
    </div>
</section>
</body>
</html>
