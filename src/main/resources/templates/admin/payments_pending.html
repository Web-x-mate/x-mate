<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đơn chờ xác nhận thanh toán</title>
    <link rel="stylesheet" th:href="@{/css/admin-inbox.css}">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <style>
        body{font:16px/1.45 system-ui,Segoe UI,Roboto,sans-serif;margin:0;padding:24px}
        h1{margin:0 0 16px}
        table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
        thead th{background:#f3f4f6;text-align:left;font-weight:700;padding:12px}
        tbody td{border-top:1px solid #eee;padding:12px;vertical-align:top}
        .muted{color:#6b7280}
        .actions{display:flex;gap:8px}
        .btn{border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
        .btn.approve{background:#2563eb;color:#fff}
        .btn.reject{background:#f43f5e;color:#fff}
        img.proof{width:140px;height:auto;border:1px solid #eee;border-radius:8px}
        .empty{padding:40px 0;text-align:center;color:#6b7280}
    </style>
</head>
<body>
<h1>Đơn chờ xác nhận thanh toán</h1>

<table>
    <thead>
    <tr>
        <th>Đơn hàng</th>
        <th>Biên lai</th>
        <th>Ghi chú KH</th>
        <th>Thao tác</th>
    </tr>
    </thead>

    <tbody>
    <!-- Rỗng -->
    <tr th:if="${#lists.isEmpty(items)}">
        <td class="empty" colspan="4">Không có biên lai chờ duyệt</td>
    </tr>

    <!-- Có dữ liệu -->
    <tr th:each="p : ${items}">
        <td>
            <!-- order có thể null: dùng Elvis (p.order?.code ?: 'N/A') -->
            <div>
                <b th:text="${p.order != null && p.order.code != null ? p.order.code : 'N/A'}">XM-0000</b>
            </div>
            <div class="muted"
                 th:text="${p.submittedAt != null ? #temporals.format(p.submittedAt,'dd/MM/yyyy HH:mm') : '--/--/---- --:--'}">
                --/--/---- --:--
            </div>
            <div class="muted"
                 th:text="'Số tiền: ' + ${#numbers.formatInteger(p.amount,3,'POINT')} + ' đ'">0 đ</div>
        </td>

        <td>
            <a th:if="${p.proofImage != null}" th:href="@{${p.proofImage}}" target="_blank" rel="noopener">
                <img class="proof" th:src="@{${p.proofImage}}" alt="Proof">
            </a>
            <div th:if="${p.proofImage == null}" class="muted">Chưa có ảnh</div>
        </td>

        <td th:text="${p.proofNote != null ? p.proofNote : '-'}">-</td>

        <td>
            <div class="actions">
                <form th:action="@{'/admin/payments/' + ${p.id} + '/approve'}" method="post">
                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                    <button class="btn approve" type="submit">Duyệt</button>
                </form>

                <form th:action="@{'/admin/payments/' + ${p.id} + '/reject'}" method="post">
                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                    <input type="hidden" name="note" value="Sai số tiền/không khớp nội dung">
                    <button class="btn reject" type="submit">Từ chối</button>
                </form>
            </div>
        </td>
    </tr>
    </tbody>
</table>
</body>
</html>
